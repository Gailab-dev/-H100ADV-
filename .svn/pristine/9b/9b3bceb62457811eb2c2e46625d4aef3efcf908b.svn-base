package com.minwon.controller;

import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.minwon.service.PositionService;
import com.minwon.vo.PositionVO;

@RestController
public class PostionController {
	@Autowired
	PositionService positionService;

	// 포지션 정보 가져오기
	@RequestMapping(value = "/positionList.do", method = RequestMethod.POST)
	public List<PositionVO> hello() throws Exception {
		return positionService.selectPositionList();
	}

	@RequestMapping(value = "/positionView.do", method = RequestMethod.GET)
	public PositionVO hello_selectone(@RequestParam Map<String, Object> param) throws Exception {
		int ps_id = Integer.parseInt((String) param.get("ps_id"));
		return positionService.selectPosition(ps_id);
	}

	// 직위 등록
	@RequestMapping(value = "/positonInsert.do", method = RequestMethod.GET)
	public String helloInsert(@RequestParam Map<String, Object> param) throws Exception {
		PositionVO vo = new PositionVO();
		vo.setPs_name((String) param.get("ps_name"));
		vo.setPs_rank(Integer.parseInt((String) param.get("ps_rank")));

		positionService.insertPosition(vo);

		return "OK";
	}

	// 직위 수정
	@RequestMapping(value = "/positionUpdate.do", method = RequestMethod.GET)
	public String helloUpdate(@RequestParam Map<String, Object> param) throws Exception {
		PositionVO vo = new PositionVO();
		vo.setPs_name((String) param.get("ps_name"));
		vo.setPs_id(Integer.parseInt((String) param.get("ps_id")));
		vo.setPs_rank(Integer.parseInt((String) param.get("ps_rank")));

		positionService.updatePosition(vo);

		return "OK";
	}
	
	@RequestMapping(value = "/positionFind.do", method = RequestMethod.GET)
	public String positionFind(@RequestParam Map<String, Object> param) throws Exception {
		String position = positionService.getPositionName((String) param.get("ps_name"));
		return position;
	}

	// 직위 삭제
	@RequestMapping(value = "/positionDelete.do", method = RequestMethod.GET)
	public String helloDelete(@RequestParam Map<String, Object> param) throws Exception {

		// 삭제 순서
		// 1. 사용하는 사용자가 있는 지확인(>0 삭제 불가)
		// select count(*) FROM user WHERE ps_id={내가 지울려는 직위_id}
		// 2. 그후 삭제
		int ps_id = Integer.parseInt((String) param.get("ps_id"));
		int positionUsersCount = positionService.getPositionUsersCount(ps_id);
		
		if (positionUsersCount > 0) {
			return "NOTOK";
		}
		
		positionService.deletePosition(ps_id);
		return "OK";
	}
}