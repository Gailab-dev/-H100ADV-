package com.minwon.controller;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;
import org.springframework.web.servlet.ModelAndView;

import com.minwon.service.ArchiveService;
import com.minwon.service.MainService;
import com.minwon.vo.ArchiveFileVO;
import com.minwon.vo.ArchiveVO;
import com.minwon.vo.SearchVO;

@Controller
@RequestMapping("/main/*")
public class ArchiveController {
	@Autowired
	ArchiveService archiveService;
	
	@Autowired
	MainService mainService;
	
	@RequestMapping("mw_archive_board.do")
	public ModelAndView minwonArchiveBoard(HttpServletRequest request
			,@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO) throws Exception {
		HttpSession session = request.getSession();
		searchVO.setSearchType(searchType);
		searchVO.setKeyword(keyword);
		searchVO.setDpId((int) session.getAttribute("userDpId"));
		List<ArchiveVO> archiveList = archiveService.getAllList(searchVO); 
		int allListCnt = archiveService.getAllListCnt(searchVO);
		for (int i = 0; i < archiveList.size(); i++) {
			Date now = archiveList.get(i).getA_writedate();
			SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
			String formattedDate = format.format(now);
			archiveList.get(i).setDate(formattedDate);
		}
		searchVO.pageInfo(page, range, allListCnt);
		ModelAndView mav = new ModelAndView();
		mav.setViewName("main/mw_archive_board");
		mav.addObject("archiveList", archiveList);
		mav.addObject("pagination", searchVO);
		return mav;
	}
	
	@RequestMapping("mw_archive_view.do")
	public ModelAndView minwonArchiveView(@RequestParam(required=false, value="id") Integer archiveId) throws Exception {
		archiveService.countUp(archiveId);
		ArchiveVO archive = archiveService.getArchive(archiveId);
		List<ArchiveFileVO> archiveFiles = archiveService.getArchiveFiles(archiveId);
		Date now = archive.getA_writedate();
		SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
		archive.setDate(format.format(now));
		ModelAndView mav = new ModelAndView();
		mav.setViewName("main/mw_archive_view");
		mav.addObject("archive", archive);
		mav.addObject("archiveFiles", archiveFiles);
		return mav;
	}
	
	@RequestMapping("mw_archive_insert.do")
	public ModelAndView minwonArchiveInsert() throws Exception {
		ModelAndView mav = new ModelAndView();
		mav.setViewName("main/mw_archive_insert");
		return mav;
	}
	
	@RequestMapping("mw_archive_update.do")
	public ModelAndView minwonArchiveUpdate(@RequestParam(required=false, value="id") Integer archiveId) throws Exception {
		ArchiveVO archive = archiveService.getArchive(archiveId);
		List<ArchiveFileVO> archiveFiles = archiveService.getArchiveFiles(archiveId);
		ModelAndView mav = new ModelAndView();
		mav.setViewName("main/mw_archive_update");
		mav.addObject("archive", archive);
		mav.addObject("archiveFiles", archiveFiles);
		return mav;
	}
	
	@RequestMapping("insert_archive.do")
	public String insertArchive(HttpServletRequest request, MultipartHttpServletRequest mRequest) throws Exception {
		HttpSession session = request.getSession();
		List<MultipartFile> multiFileList = mRequest.getFiles("a_files");
		System.out.println(multiFileList.get(0).getOriginalFilename());
		ArchiveVO archiveVO = new ArchiveVO();
		archiveVO.setA_title(request.getParameter("a_title"));
		archiveVO.setA_content(request.getParameter("a_content"));
		archiveVO.setDp_id((int) session.getAttribute("userDpId"));
		archiveVO.setDp_name(mainService.getDepartment((int) session.getAttribute("userDpId")));
		archiveVO.setU_id((int) session.getAttribute("userId"));
		archiveVO.setU_name(session.getAttribute("userName").toString());
		archiveService.insertArchive(archiveVO);
		
		for (MultipartFile mf : multiFileList) {
			if (mf != null && !mf.isEmpty()) {
				String saveDir = "/home/upload/archive_files/";
				ArchiveFileVO archiveFileVO = new ArchiveFileVO();
				String originalFileName = mf.getOriginalFilename();
				String savedFile = saveDir + originalFileName;
				try {
					mf.transferTo(new File(savedFile));
				} catch (IllegalStateException e) {
					e.printStackTrace();
				} catch (IOException e) {
					e.printStackTrace();
				}
				archiveFileVO.setAf_file_name(originalFileName);
				archiveFileVO.setU_id((int) session.getAttribute("userId"));
				archiveService.insertArchiveFile(archiveFileVO);
			}
		}
		return "redirect:/main/mw_archive_board.do";
	}
	
	@RequestMapping("update_archive.do")
	public String updateArchive(@ModelAttribute ArchiveVO vo) throws Exception {
		archiveService.updateArchive(vo);
		return "redirect:/main/mw_archive_view.do?id=" + vo.getA_id();
	}
	
	@RequestMapping(value="delete_archive.do", method = RequestMethod.GET)
	public String deleteArchive(@RequestParam(required=false, value="id") Integer archiveId) throws Exception {
		archiveService.deleteArchiveFiles(archiveId);
		archiveService.deleteArchive(archiveId);
		
		return "redirect:/main/mw_archive_board.do";
	}
}
