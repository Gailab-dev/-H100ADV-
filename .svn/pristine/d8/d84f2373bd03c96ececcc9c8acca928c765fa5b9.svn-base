<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="main">
	<resultMap type="com.minwon.vo.ComplaintVO" id="complaintMap">
		<id property="cId" column="c_id" />
		<result property="uId" column="u_id" />
		<result property="dpId" column="dp_id" />
		<result property="dpName" column="dp_name" />
		<result property="dpMasterName" column="dp_master_name" />
		<result property="dpId01" column="dp_id_01" />
		<result property="dpName01" column="dp_name_01" />
		<result property="dpId02" column="dp_id_02" />
		<result property="dpName02" column="dp_name_02" />
		<result property="dpId03" column="dp_id_03" />
		<result property="dpName03" column="dp_name_03" />
		<result property="dpId04" column="dp_id_04" />
		<result property="dpName04" column="dp_name_04" />
		<result property="dpId05" column="dp_id_05" />
		<result property="dpId06" column="dp_id_06" />
		<result property="cTitle" column="c_title" />
		<result property="cWriteDate" column="c_writedate" />
		<result property="cWriteDateCount" column="c_writedate_count" />
		<result property="cAddress" column="c_address" />
		<result property="cDistrict" column="c_district" />
		<result property="cPetitioner" column="c_petitioner" />
		<result property="cPetitionerPhone" column="c_petitioner_phone" />
		<result property="cPetitionerAddress" column="c_petitioner_address" />
		<result property="cPetitionerSpecific" column="c_petitioner_specific" />
		<result property="cReceiptDate" column="c_receipt_date" />
		<result property="cReceiptWay" column="c_receipt_way" />
		<result property="cRaiseDate" column="c_raise_date" />
		<result property="cRaiseCount" column="c_raise_count" />
		<result property="cDepartment" column="c_department" />
		<result property="cOfficer01" column="c_officer1" />
		<result property="cOfficer02" column="c_officer2" />
		<result property="cOfficer03" column="c_officer3" />
		<result property="cKeyPoint" column="c_keypoint" />
		<result property="cContent" column="c_content" />
		<result property="cPlan" column="c_plan" />
		<result property="cComplete" column="c_complete" />
		<result property="cDeadline" column="c_deadline" />
		<result property="cNotificated"  column="c_notificated" />
		<result property="cSatisfiction" column="c_satisfiction" />
		<result property="cClient" column="c_client" />
		<result property="cReference" column="c_reference" />
		<result property="cCount" column="c_count" />
		<result property="cReplyCount" column="c_reply_count" />
		<result property="cSeparationType" column="c_separation_type" />
		<result property="cProcessClass" column="c_process_class" />
		<result property="cAdminNum" column="c_admin_num" />
		<result property="cAnswer" column="c_answer" />
		<collection property="replies" resultMap="complaintReplyMap" />
	</resultMap>
	
	<resultMap type="com.minwon.vo.ComplaintSettleVO" id="complaintSettleMap">
		<id property="csId" column="cs_id" />
		<result property="cId" column="c_id" />
		<result property="uId" column="u_id" />
		<result property="dpName" column="dp_name" />
		<result property="psName" column="ps_name" />
		<result property="uName" column="u_name" />
		<result property="csDate" column="cs_date" />
		<result property="csContent" column="cs_content" />
	</resultMap>
	
	<resultMap type="com.minwon.vo.ComplaintImageVO" id="complaintImageMap">
		<id property="ciId" column="ci_id" />
		<result property="cId" column="c_id" />
		<result property="uId" column="u_id" />
		<result property="dpName" column="dp_name" />
		<result property="psName" column="ps_name" />
		<result property="uName" column="u_name" />
		<result property="ciDate" column="ci_date" />
		<result property="ciContent" column="ci_content" />
		<result property="ciImage" column="ci_image" />
	</resultMap>
	
	<resultMap type="com.minwon.vo.ComplaintFileVO" id="complaintFileMap">
		<id property="cfId" column="cf_id" />
		<result property="cId" column="c_id" />
		<result property="uId" column="u_id" />
		<result property="uName" column="u_name" />
		<result property="cfFileLogic" column="cf_file_logic" />
		<result property="cfContent" column="cf_content" />
	</resultMap>
	
	<resultMap type="com.minwon.vo.ComplaintReplyVO" id="complaintReplyMap">
		<id property="crId" column="cr_id" />
		<result property="cId" column="c_id" />
		<result property="uId" column="u_id" />
		<result property="dpName" column="dp_name" />
		<result property="psName" column="ps_name" />
		<result property="uName" column="u_name" />
		<result property="crDate" column="cr_date" />
		<result property="crContent" column="cr_content" />
		<result property="cTitle" column="c_title" />
		<result property="cNotificated" column="c_notificated" />
	</resultMap>
	
	<select id="loginCheck" resultType="String">
		SELECT u_name as userName FROM user
		WHERE u_login_id = #{userLoginId} AND u_login_pwd = #{userLoginPwd}
	</select>
	
	<insert id="insertIpLog" parameterType="com.minwon.vo.IpLogVO">
		INSERT INTO 
			ip_log(u_name, dp_name, il_ip, il_login_time)
		VALUES (#{uName}, #{dpName}, #{ilIp}, now())
	</insert>
	
	<select id="findId" resultType="String">
		SELECT u_login_id
		FROM user
		WHERE u_gpki_dn=#{dn}
	</select>
	
	<select id="viewMember" resultType="com.minwon.vo.MainLoginVO">
		SELECT
			u_id as uId,
			u_name as userName,
			dp_id as dpId,
			ps_id as psId,
			u_grade as userGrade,
			u_login_id as userLoginId,
			u_login_pwd as userLoginPwd,
			u_email as userEmail,
			u_admin_num as userAdminNum
		FROM user
		WHERE u_login_id = #{userLoginId} AND u_login_pwd = #{userLoginPwd}
	</select>
	
	<select id="viewDepartment" resultType="String">
		SELECT dp_name FROM department WHERE dp_id = #{dpId}
	</select>
	
	<select id="relatedDepartments" resultType="String">
		SELECT dp_name 
		FROM department 
		WHERE dp_depth = 2
		order by dp_name
	</select>
	
	<select id="relatedDepartments2" resultType="String">
		SELECT dp_name 
		FROM department 
		WHERE dp_depth = 3
		order by dp_name
	</select>
	
	<select id="allDepartments" resultType="String">
		SELECT dp_name 
		FROM department 
		order by dp_name
	</select>
	
	<insert id="insertComplaint" parameterType="com.minwon.vo.ComplaintVO">
		INSERT INTO 
			complaint(u_id, dp_id, dp_master_name, dp_name, dp_id_01, 
				dp_name_01, dp_id_02, dp_name_02, 
				dp_id_03, dp_name_03, dp_id_04,
				dp_name_04, dp_id_05, dp_id_06, c_title, c_writedate,
				c_writedate_count, c_address, c_district,
				c_petitioner, c_petitioner_phone, c_petitioner_address,
				c_petitioner_specific, c_receipt_date, c_receipt_way,
				c_raise_date, c_raise_count, c_department,
				c_officer1, c_officer2, c_officer3,
				c_keypoint, c_content, c_plan, c_complete,
				c_deadline, c_notificated, c_satisfiction,
				c_client, c_reference, c_count, c_reply_count, c_separation_type, c_process_class, c_admin_num)
		VALUES (#{uId}, (select dp_id from department where dp_name=#{cDepartment}), (select dp_name from department where dp_id=(select case when dp_depth = 3 then dp_pid else dp_id end as 'depth' from department where dp_name=#{cDepartment})),#{cDepartment},
		 <choose>
		 	<when test="dpName01 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName01}),  
		 	</otherwise>
		 </choose>
		 #{dpName01},
		 <choose>
		 	<when test="dpName02 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName02}), 
		 	</otherwise>
		 </choose>
		 #{dpName02},
		 <choose>
		 	<when test="dpName03 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName03}),  
		 	</otherwise>
		 </choose>
		 #{dpName03},
		 <choose>
		 	<when test="dpName04 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName04}),  
		 	</otherwise>
		 </choose>
		 #{dpName04}, (select dp_id + 1 from department where dp_name = #{cDistrict}), (select dp_id + 2 from department where dp_name = #{cDistrict}),
		 #{cTitle}, now(), (select NVL(MAX(c.c_writedate_count), DATE_FORMAT(NOW(), '%y%m%d') * 1000) + 1 FROM complaint c WHERE c.c_writedate = (SELECT date_format(NOW(), '%Y-%m-%d'))), #{cAddress},
			#{cDistrict}, #{cPetitioner}, #{cPetitionerPhone}, #{cPetitionerAddress}, #{cPetitionerSpecific}, #{cReceiptDate}, #{cReceiptWay},
			#{cRaiseDate}, #{cRaiseCount}, #{cDepartment}, #{cOfficer01}, #{cOfficer02}, #{cOfficer03}, #{cKeyPoint}, #{cContent}, #{cPlan}, "1",
			now(), 1, "보통", "없음", "없음", 0, 0, #{cSeparationType}, #{cProcessClass}, #{cAdminNum})
	</insert>
	
	<insert id="registerComplaint" parameterType="com.minwon.vo.ComplaintVO">
		INSERT INTO 
			complaint(u_id, dp_id, dp_master_name, dp_name, dp_id_01, 
				dp_name_01, dp_id_02, dp_name_02, 
				dp_id_03, dp_name_03, dp_id_04, 
				dp_name_04, dp_id_05, dp_id_06, c_title, c_writedate,
				c_writedate_count, c_address, c_district,
				c_petitioner, c_petitioner_phone, c_petitioner_address,
				c_petitioner_specific, c_receipt_date, c_receipt_way,
				c_raise_date, c_raise_count, c_department,
				c_officer1, c_officer2, c_officer3,
				c_keypoint, c_content, c_plan, c_complete,
				c_deadline, c_notificated, c_satisfiction,
				c_client, c_reference, c_count, c_reply_count, c_separation_type, c_process_class, c_admin_num)
		VALUES (#{uId}, #{dpId}, (select dp_name from department where dp_id=(select case when dp_depth = 3 then dp_pid else dp_id end as 'depth' from department where dp_id=#{dpId})), #{cDepartment},
		 <choose>
		 	<when test="dpName01 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName01}),  
		 	</otherwise>
		 </choose>
		 #{dpName01},
		 <choose>
		 	<when test="dpName02 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName02}), 
		 	</otherwise>
		 </choose>
		 #{dpName02},
		 <choose>
		 	<when test="dpName03 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName03}),  
		 	</otherwise>
		 </choose>
		 #{dpName03},
		 <choose>
		 	<when test="dpName04 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName04}),  
		 	</otherwise>
		 </choose>
		 #{dpName04}, (select dp_id + 1 from department where dp_name = #{cDistrict}), (select dp_id + 2 from department where dp_name = #{cDistrict}),
		 #{cTitle}, now(), (select NVL(MAX(c.c_writedate_count), DATE_FORMAT(NOW(), '%y%m%d') * 1000) + 1 FROM complaint c WHERE c.c_writedate = (SELECT date_format(NOW(), '%Y-%m-%d'))), #{cAddress},
			#{cDistrict}, #{cPetitioner}, #{cPetitionerPhone}, #{cPetitionerAddress}, #{cPetitionerSpecific}, #{cReceiptDate}, #{cReceiptWay},
			#{cRaiseDate}, #{cRaiseCount}, #{cDepartment}, #{cOfficer01}, #{cOfficer02}, #{cOfficer03}, #{cKeyPoint}, #{cContent}, #{cPlan}, "1",
			now(), 2, "보통", "없음", "없음", 0, 0, #{cSeparationType}, #{cProcessClass}, #{cAdminNum})
	</insert>
	
	<insert id="insertComplaintExcel" parameterType="com.minwon.vo.ComplaintVO">
		INSERT INTO 
			complaint(u_id, dp_id, dp_master_name, dp_name, dp_id_01, 
				dp_name_01, dp_id_02, dp_name_02, 
				dp_id_03, dp_name_03, dp_id_04, 
				dp_name_04, dp_id_05, dp_id_06, c_title, c_writedate,
				c_writedate_count, c_address, c_district,
				c_petitioner, c_petitioner_phone, c_petitioner_address,
				c_petitioner_specific, c_receipt_date, c_receipt_way,
				c_raise_date, c_raise_count, c_department,
				c_officer1, c_officer2, c_officer3,
				c_keypoint, c_content, c_plan, c_complete,
				c_deadline, c_notificated, c_satisfiction,
				c_client, c_reference, c_count, c_reply_count, c_admin_num)
		VALUES (#{uId}, #{dpId}, (select dp_name from department where dp_id=(select case when dp_depth = 3 then dp_pid else dp_id end as 'depth' from department where dp_id=#{dpId})), #{cDepartment}, <choose>
		 	<when test="dpName01 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName01}),  
		 	</otherwise>
		 </choose>
		 #{dpName01},
		 <choose>
		 	<when test="dpName02 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName02}), 
		 	</otherwise>
		 </choose>
		 #{dpName02},
		 <choose>
		 	<when test="dpName03 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName03}),  
		 	</otherwise>
		 </choose>
		 #{dpName03},
		 <choose>
		 	<when test="dpName04 == '없음'">
		 		0,
		 	</when>
		 	<otherwise>
		 		(select dp_id from department where dp_name=#{dpName04}),  
		 	</otherwise>
		 </choose>
		 #{dpName04}, (select dp_id + 1 from department where dp_name = #{cDistrict}), (select dp_id + 2 from department where dp_name = #{cDistrict}),
		  #{cTitle}, now(), (select NVL(MAX(c.c_writedate_count), DATE_FORMAT(NOW(), '%y%m%d') * 1000) + 1 FROM complaint c WHERE c.c_writedate = (SELECT date_format(NOW(), '%Y-%m-%d'))), #{cAddress},
			#{cDistrict}, #{cPetitioner}, #{cPetitionerPhone}, #{cPetitionerAddress}, #{cPetitionerSpecific}, #{cReceiptDate}, #{cReceiptWay},
			#{cRaiseDate}, #{cRaiseCount}, #{cDepartment}, #{cOfficer01}, #{cOfficer02}, #{cOfficer03}, #{cKeyPoint}, #{cContent}, #{cPlan}, "1",
			now(), -1, "보통", "없음", "없음", 0, 0, #{cAdminNum})
	</insert>
	
	<update id="updateSeparationType" parameterType="com.minwon.vo.ComplaintVO">
		UPDATE complaint
		SET
			c_separation_type=#{cSeparationType},
			c_process_class=#{cProcessClass}
		WHERE c_id=#{cId}
	</update>
	
	<update id="updateComplaint" parameterType="com.minwon.vo.ComplaintVO">
		UPDATE complaint 
		SET 
			dp_id=(select dp_id from department where dp_name=#{cDepartment}),
			dp_master_name=(select dp_name from department where dp_id=(select case when dp_depth = 3 then dp_pid else dp_id end as 'depth' from department where dp_name=#{cDepartment})),
			dp_name=#{cDepartment},
			c_title=#{cTitle},
			c_address=#{cAddress},
			c_district=#{cDistrict},
			c_petitioner=#{cPetitioner},
			c_petitioner_phone=#{cPetitionerPhone},
			c_petitioner_address=#{cPetitionerAddress},
			c_petitioner_specific=#{cPetitionerSpecific},
			c_receipt_date=#{cReceiptDate},
			c_receipt_way=#{cReceiptWay},
			c_raise_date=#{cRaiseDate},
			c_raise_count=#{cRaiseCount},
			c_officer1=#{cOfficer01},
			c_officer2=#{cOfficer02},
			c_officer3=#{cOfficer03},
			c_department=#{cDepartment},
			dp_name_01=#{dpName01},
			dp_name_02=#{dpName02},
			dp_name_03=#{dpName03},
			dp_name_04=#{dpName04},
			dp_id_05=(select dp_id + 1 from department where dp_name=#{cDistrict}),
			dp_id_06=(select dp_id + 2 from department where dp_name=#{cDistrict}),
			c_keypoint=#{cKeyPoint},
			c_content=#{cContent},
			c_plan=#{cPlan},
			c_separation_type=#{cSeparationType},
			c_process_class=#{cProcessClass},
			c_admin_num=#{cAdminNum}
		WHERE c_id=#{cId}
	</update>
	
	<update id="updateProcess" parameterType="com.minwon.vo.ComplaintVO">
		UPDATE complaint
		SET 
			c_answer=#{cAnswer},
			c_complete=#{cComplete},
			c_deadline=#{cDeadline},
			c_notificated=#{cNotificated},
			c_satisfiction=#{cSatisfiction},
			c_client=#{cClient},
			c_reference=#{cReference}
		WHERE c_id=#{cId} AND (c_notificated IN (1, 2));
	</update>
	
	<select id="viewTempComplaints" resultMap="complaintMap">
		SELECT * 
		FROM complaint
		WHERE c_notificated=1 AND u_id=#{uId}
	</select>
	
	<select id="viewExcelComplaints" resultMap="complaintMap">
		SELECT * 
		FROM complaint
		WHERE c_notificated=-1 AND u_id=#{uId}
	</select>
	
	<select id="tempComplaintsCount" resultType="Integer">
		SELECT count(*)
		FROM complaint
		WHERE c_notificated=1 AND u_id=#{uId} 
	</select>
	
	<select id="viewTempComplaint" resultMap="complaintMap">
		SELECT * 
		FROM complaint
		WHERE c_notificated=1 AND c_id=#{cId}
	</select>
	
	<select id="getDepartmentBoss" resultType="String">
		SELECT u_name
		FROM user
		WHERE dp_id=#{dpId}
		AND ps_id=5
		LIMIT 1
	</select>
	
	<select id="getParentDepartmentBoss" resultType="String">
		SELECT u_name
		FROM user
		WHERE dp_id=(SELECT dp_pid FROM department WHERE dp_id=#{dpId})
		AND ps_id=4
		LIMIT 1
	</select>
	
	<select id="viewComplaint" resultMap="complaintMap">
		SELECT * 
		FROM complaint
		WHERE c_notificated IN (2, 9) AND c_id=#{cId}
	</select>
	
	<update id="processExcelComplaint">
		UPDATE complaint
		SET c_notificated = 1
		WHERE c_id=#{cId}
	</update>
	
	<update id="processComplaint">
		UPDATE complaint
		SET c_notificated = 2
		WHERE c_id=#{cId}
	</update>
	
	<update id="completeComplaint">
		UPDATE complaint
		SET c_notificated = 9
		WHERE c_id=#{cId}
	</update>
	
	<delete id="deleteComplaint">
		DELETE from complaint
		WHERE c_id=#{cId}
	</delete>
	
	<select id="viewAllSearchComplaint" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT *
		FROM complaint 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND c_notificated in (2, 9)
			AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND c_content like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='petitioner' and keyword != null and keyword != '' ">
				AND c_petitioner like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='officer' and keyword != null and keyword != '' ">
				AND c_officer3 like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='serial' and keyword != null and keyword != '' ">
				AND c_writedate_count like CONCAT('%', #{keyword}, '%') 
			</if>	
			<if test="searchType=='district' and keyword != null and keyword != '' ">
				AND c_district like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='department' and keyword != null and keyword != '' ">
				AND dp_master_name like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='separation' and keyword != null and keyword != '' ">
				AND c_separation_type like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='process' and keyword != null and keyword != '' ">
				AND c_process_class like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType2=='process' and keyword2 != null and keyword2 != '' ">
				AND c_process_class like CONCAT('%', #{keyword2}, '%') 
			</if>
			<if test="searchType=='dong' and keyword=='기타'">
				AND dp_master_name in (select dp_name from department where dp_pid = 171)
			</if>
		</trim> 
		ORDER BY c_id DESC
        LIMIT #{startList}, #{listSize}
	</select>
	
	<select id="viewAllSearchComplaintCnt" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND c_notificated in (2, 9)
			AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND c_content like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='petitioner' and keyword != null and keyword != '' ">
				AND c_petitioner like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='officer' and keyword != null and keyword != '' ">
				AND c_officer3 like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='serial' and keyword != null and keyword != '' ">
				AND c_writedate_count like CONCAT('%', #{keyword}, '%') 
			</if>	
			<if test="searchType=='district' and keyword != null and keyword != '' ">
				AND c_district like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='department' and keyword != null and keyword != '' ">
				AND dp_master_name like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='separation' and keyword != null and keyword != '' ">
				AND c_separation_type like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='process' and keyword != null and keyword != '' ">
				AND c_process_class like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType2=='process' and keyword2 != null and keyword2 != '' ">
				AND c_process_class like CONCAT('%', #{keyword2}, '%') 
			</if>
			<if test="searchType=='dong' and keyword=='기타'">
				AND dp_master_name in (select dp_name from department where dp_pid = 171)
			</if>
		</trim> 
	</select>
	
	<select id="allSearchComplaintCnt" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated in (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	
	<select id="viewSearchComplaint" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT *
		FROM complaint 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND c_notificated in (2, 9)
			AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND c_content like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='petitioner' and keyword != null and keyword != '' ">
				AND c_petitioner like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='officer' and keyword != null and keyword != '' ">
				AND c_officer3 like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='serial' and keyword != null and keyword != '' ">
				AND c_writedate_count like CONCAT('%', #{keyword}, '%') 
			</if>	
			<if test="searchType=='district' and keyword != null and keyword != '' ">
				AND c_district like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='department' and keyword != null and keyword != '' ">
				AND dp_master_name like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='separation' and keyword != null and keyword != '' ">
				AND c_separation_type like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='process' and keyword != null and keyword != '' ">
				AND c_process_class like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="startDate != null and startDate != ''">
				<![CDATA[
				AND c_receipt_date >= #{startDate}
				]]>
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND c_receipt_date < DATE_ADD(#{endDate}, INTERVAL 1 DAY)
				]]>
			</if>
		</trim> 
		ORDER BY c_id DESC
        LIMIT #{startList}, #{listSize}
	</select>
	
	<select id="viewSearchComplaintCnt" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND c_notificated in (2, 9)
			AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND c_content like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='petitioner' and keyword != null and keyword != '' ">
				AND c_petitioner like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='officer' and keyword != null and keyword != '' ">
				AND c_officer3 like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='serial' and keyword != null and keyword != '' ">
				AND c_writedate_count like CONCAT('%', #{keyword}, '%') 
			</if>	
			<if test="searchType=='district' and keyword != null and keyword != '' ">
				AND c_district like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='department' and keyword != null and keyword != '' ">
				AND dp_master_name like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='separation' and keyword != null and keyword != '' ">
				AND c_separation_type like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='process' and keyword != null and keyword != '' ">
				AND c_process_class like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="startDate != null and startDate != ''">
				<![CDATA[
				AND c_receipt_date >= #{startDate}
				]]>
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND c_receipt_date < DATE_ADD(#{endDate}, INTERVAL 1 DAY)
				]]>
			</if>
		</trim> 
	</select>
	
	<select id="SearchComplaintCnt" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated in (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="viewSearchCompleteComplaint" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT *
		FROM complaint 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND c_notificated=9
			AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND c_content like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='petitioner' and keyword != null and keyword != '' ">
				AND c_petitioner like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='officer' and keyword != null and keyword != '' ">
				AND c_officer3 like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='serial' and keyword != null and keyword != '' ">
				AND c_writedate_count like CONCAT('%', #{keyword}, '%') 
			</if>	
			<if test="searchType=='district' and keyword != null and keyword != '' ">
				AND c_district like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='department' and keyword != null and keyword != '' ">
				AND (c_department like CONCAT('%', #{keyword}, '%') OR dp_name_01 like CONCAT('%', #{keyword}, '%') OR dp_name_02 like CONCAT('%', #{keyword}, '%') OR dp_name_03 like CONCAT('%', #{keyword}, '%') OR dp_name_04 like CONCAT('%', #{keyword}, '%'))
			</if>
			<if test="searchType=='separation' and keyword != null and keyword != '' ">
				AND c_separation_type like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='process' and keyword != null and keyword != '' ">
				AND c_process_class like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="startDate != null and startDate != ''">
				<![CDATA[
				AND c_receipt_date >= #{startDate}
				]]>
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND c_receipt_date < DATE_ADD(#{endDate}, INTERVAL 1 DAY)
				]]>
			</if>
		</trim> 
		ORDER BY c_id DESC
        LIMIT #{startList}, #{listSize}
	</select>
	
	<select id="SearchCompletedComplaintCnt" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated=9
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="viewSearchCompleteComplaintCnt" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND c_notificated=9
			AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND c_content like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='petitioner' and keyword != null and keyword != '' ">
				AND c_petitioner like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='officer' and keyword != null and keyword != '' ">
				AND c_officer3 like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='serial' and keyword != null and keyword != '' ">
				AND c_writedate_count like CONCAT('%', #{keyword}, '%') 
			</if>	
			<if test="searchType=='district' and keyword != null and keyword != '' ">
				AND c_district like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='department' and keyword != null and keyword != '' ">
				AND (c_department like CONCAT('%', #{keyword}, '%') OR dp_name_01 like CONCAT('%', #{keyword}, '%') OR dp_name_02 like CONCAT('%', #{keyword}, '%') OR dp_name_03 like CONCAT('%', #{keyword}, '%') OR dp_name_04 like CONCAT('%', #{keyword}, '%'))
			</if>
			<if test="searchType=='separation' and keyword != null and keyword != '' ">
				AND c_separation_type like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='process' and keyword != null and keyword != '' ">
				AND c_process_class like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="startDate != null and startDate != ''">
				<![CDATA[
				AND c_receipt_date >= #{startDate}
				]]>
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND c_receipt_date < DATE_ADD(#{endDate}, INTERVAL 1 DAY)
				]]>
			</if>
		</trim> 
	</select>
	
	<select id="viewAllComplaintReplies" resultMap="complaintReplyMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid FROM department AS a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT *
		FROM complaint
		INNER JOIN complaint_reply
		ON complaint.c_id = complaint_reply.c_id
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND complaint.c_id IN (SELECT c_id FROM complaint WHERE c_notificated IN (2, 9))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND complaint.c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND cr_content like CONCAT('%', #{keyword}, '%') 
			</if>
			AND ((complaint.dp_id IN (SELECT dp_id FROM cte) OR complaint.dp_id_01 IN (SELECT dp_id FROM cte) OR complaint.dp_id_02 IN (SELECT dp_id FROM cte) OR complaint.dp_id_03 IN (SELECT dp_id FROM cte) OR complaint.dp_id_04 IN (SELECT dp_id FROM cte) OR complaint.dp_id_05 IN (SELECT dp_id FROM cte) OR complaint.dp_id_06 IN (SELECT dp_id FROM cte)))
		</trim> 
		ORDER BY cr_id DESC
        LIMIT #{startList}, #{listSize}
	</select>
	
	<select id="viewAllComplaintRepliesCnt" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid FROM department AS a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint
		INNER JOIN complaint_reply
		ON complaint.c_id = complaint_reply.c_id
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			AND complaint.c_id IN (SELECT c_id FROM complaint WHERE c_notificated IN (2, 9))
			<if test="searchType=='title' and keyword != null and keyword != '' ">
				AND complaint.c_title like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType=='content' and keyword != null and keyword != '' ">
			    AND cr_content like CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="startDate != null">
				<![CDATA[
				AND c_receipt_date >= #{startDate}
				]]>
			</if>
			AND ((complaint.dp_id IN (SELECT dp_id FROM cte) OR complaint.dp_id_01 IN (SELECT dp_id FROM cte) OR complaint.dp_id_02 IN (SELECT dp_id FROM cte) OR complaint.dp_id_03 IN (SELECT dp_id FROM cte) OR complaint.dp_id_04 IN (SELECT dp_id FROM cte) OR complaint.dp_id_05 IN (SELECT dp_id FROM cte) OR complaint.dp_id_06 IN (SELECT dp_id FROM cte)))
		</trim> 
	</select>
	
	<select id="viewRecentCompletedReplies" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid FROM department AS a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT complaint.c_id, complaint.c_department, complaint.c_writedate, complaint_reply.cr_content, complaint_reply.cr_date
		FROM complaint
		INNER JOIN complaint_reply
		ON complaint.c_id = complaint_reply.c_id
		WHERE complaint.c_id IN (SELECT c_id FROM complaint WHERE c_notificated = 9)
		AND ((dp_id IN (SELECT dp_id FROM cte) OR dp_id_01 IN (SELECT dp_id FROM cte) OR dp_id_02 IN (SELECT dp_id FROM cte) OR dp_id_03 IN (SELECT dp_id FROM cte) OR dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte)))
		ORDER BY complaint_reply.cr_id DESC
        LIMIT 5
	</select>
	
	<select id="viewRecentNotCompletedReplies" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid FROM department AS a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT complaint.c_id, complaint.c_department, complaint.c_writedate, complaint_reply.cr_content, complaint_reply.cr_date
		FROM complaint
		INNER JOIN complaint_reply
		ON complaint.c_id = complaint_reply.c_id
		WHERE complaint.c_id IN (SELECT c_id FROM complaint WHERE c_notificated = 2)
		AND ((dp_id IN (SELECT dp_id FROM cte) OR dp_id_01 IN (SELECT dp_id FROM cte) OR dp_id_02 IN (SELECT dp_id FROM cte) OR dp_id_03 IN (SELECT dp_id FROM cte) OR dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte)))
		ORDER BY complaint_reply.cr_id DESC
        LIMIT 5
	</select>
	
	<select id="viewRecentNonCompletedComplaints" parameterType="map" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_id, c_department, c_writedate, c_writedate_count, c_district, c_petitioner, c_title, dp_name_01, dp_name_02, dp_name_03, dp_name_04
		FROM complaint 
		WHERE c_process_class='처리중'
		AND c_notificated != -99
		AND c_notificated != 1
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		ORDER BY c_id DESC
        LIMIT 5
	</select>
	
	<select id="viewRecentCompletedComplaints" parameterType="map" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_id, c_department, c_writedate, c_writedate_count, c_district, c_petitioner, c_title, dp_name_01, dp_name_02, dp_name_03, dp_name_04
		FROM complaint 
		WHERE c_process_class='처리완료'
		AND c_notificated != -99
		AND c_notificated != 1
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		ORDER BY c_id DESC
        LIMIT 5
	</select>
	
	<select id="viewRecentReviewingComplaints" parameterType="map" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_id, c_department, c_writedate, c_writedate_count, c_district, c_petitioner, c_title, dp_name_01, dp_name_02, dp_name_03, dp_name_04
		FROM complaint 
		WHERE c_process_class='중장기검토'
		AND c_notificated != -99
		AND c_notificated != 1
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		ORDER BY c_id DESC
        LIMIT 5
	</select>
	
	<select id="viewRecentCooperateComplaints" parameterType="map" resultMap="complaintMap">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_id, c_department, c_writedate, c_writedate_count, c_district, c_petitioner, c_title, dp_name_01, dp_name_02, dp_name_03, dp_name_04
		FROM complaint 
		WHERE c_process_class='타기관협조'
		AND c_notificated != -99
		AND c_notificated != 1
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		ORDER BY c_id DESC
        LIMIT 5
	</select>
	
	<select id="chargeOfComplaintsCount" parameterType="map" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="relatedComplaintsCount" parameterType="map" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="todayComplaintsCount" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND c_writedate=curdate()
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<insert id="insertSettle" parameterType="com.minwon.vo.ComplaintSettleVO">
		INSERT INTO 
			complaint_settle(c_id, u_id, dp_name, ps_name, u_name, cs_date, cs_content)
		VALUES
			(#{cId}, #{uId}, #{dpName}, #{psName}, #{uName}, #{csDate}, #{csContent})
	</insert>
	
	<select id="viewComplaintSettles" resultMap="complaintSettleMap">
		SELECT * FROM complaint_settle WHERE c_id=#{cId}
	</select>
	
	<insert id="insertImage" parameterType="java.util.Map">
		INSERT INTO 
			complaint_image(c_id, u_id, dp_name, ps_name, u_name, ci_date, ci_content, ci_image, ci_blob)
		VALUES
			(#{cId}, #{uId}, #{dpName}, #{psName}, #{uName}, now(), #{ciContent}, #{ciImage}, #{ciBlob})
	</insert>
	
	<insert id="insertFile" parameterType="com.minwon.vo.ComplaintFileVO">
		INSERT INTO 
			complaint_file(c_id, u_id, u_name, cf_file_logic, cf_content)
		VALUES
			(#{cId}, #{uId}, #{uName}, #{cfFileLogic}, #{cfContent})
	</insert>
	
	<select id="viewComplaintImages" resultMap="complaintImageMap">
		SELECT * FROM complaint_image WHERE c_id=#{cId}
	</select>
	
	<select id="viewComplaintFiles" resultMap="complaintFileMap">
		SELECT * FROM complaint_file WHERE c_id=#{cId}
	</select>
	
	<insert id="insertReply" parameterType="com.minwon.vo.ComplaintReplyVO">
		INSERT INTO 
			complaint_reply(c_id, u_id, dp_name, ps_name, u_name, cr_date, cr_content, c_title, c_notificated)
		VALUES
			(#{cId}, #{uId}, #{dpName}, #{psName}, #{uName}, now(), #{crContent}, (SELECT c_title FROM complaint WHERE c_id=#{cId}), (SELECT c_notificated FROM complaint WHERE c_id=#{cId}))
	</insert>
	
	<select id="viewComplaintReplies" resultMap="complaintReplyMap">
		SELECT * FROM complaint_reply WHERE c_id=#{cId}
	</select>
	
	<select id="checkId" parameterType="String" resultType="int">
		select count(*) from user where u_login_id=#{member_id}
	</select>
	
	<select id="certificateLogincheck" parameterType="String" resultType="com.minwon.vo.UserVO">
		SELECT * FROM user WHERE u_gpki_dn=#{dn}
	</select>
	
	<select id="getGroupedDistrict" parameterType="map" resultType="map">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_district, c_process_class, count(*) as cdcount
		FROM complaint
		WHERE c_notificated in (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		GROUP BY c_district, c_process_class
	</select>
	
	<select id="getGroupedDistrictSum" parameterType="map" resultType="map">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_district, count(*) as cdcount
		FROM complaint
		WHERE c_notificated in (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		GROUP BY c_district
	</select>
	
	<select id="getGroupedSeparationType" parameterType="map" resultType="map">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_separation_type, c_process_class, count(*) as cstcount
		FROM complaint
		WHERE c_notificated in (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		GROUP BY c_separation_type, c_process_class
	</select>
	
	<select id="getGroupedSeparationTypeSum" parameterType="map" resultType="map">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT c_separation_type, count(*) as cstcount
		FROM complaint
		WHERE c_notificated in (2, 9)
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
		GROUP BY c_separation_type
	</select>
	
	<select id="getGroupedDepartment" parameterType="map" resultType="map">
		WITH RECURSIVE cte AS (
		    SELECT dp_id, dp_pid, dp_depth, dp_name
		    FROM department 
		    WHERE dp_id = #{dpId}
		    UNION ALL
		    SELECT a.dp_id, a.dp_pid, a.dp_depth, a.dp_name
		    FROM department AS a
		    INNER JOIN cte AS b ON b.dp_id = a.dp_pid
		)
		SELECT 
		    CASE 
		        WHEN d.dp_depth = 3 THEN (
		            SELECT dp_name 
		            FROM department 
		            WHERE dp_id = d.dp_pid
		        )
		        WHEN d.dp_depth = 2 THEN d.dp_name
		    END AS original_dpname,
		    CASE 
		        WHEN (
		            CASE 
		                WHEN d.dp_depth = 3 THEN (
		                    SELECT dp_name 
		                    FROM department 
		                    WHERE dp_id = d.dp_pid
		                )
		                WHEN d.dp_depth = 2 THEN d.dp_name
		            END
		        ) IN ('충장동', '동명동', '계림1동', '계림2동', '산수1동', '산수2동', '지산1동', '지산2동', '서남동', '학동', '학운동', '지원1동', '지원2동')
		        THEN '기타'
		        ELSE (
		            CASE 
		                WHEN d.dp_depth = 3 THEN (
		                    SELECT dp_name 
		                    FROM department 
		                    WHERE dp_id = d.dp_pid
		                )
		                WHEN d.dp_depth = 2 THEN d.dp_name
		            END
		        )
		    END AS dpname,
		    c.c_process_class, 
		    COUNT(*) AS cdpcount
		FROM 
		    complaint c
		JOIN 
		    department d ON c.dp_id = d.dp_id
		WHERE 
		    c.c_notificated IN (2, 9)
		    AND (
		        c.dp_id IN (SELECT dp_id FROM cte)
		        OR c.dp_id_01 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_02 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_03 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_04 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_05 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_06 IN (SELECT dp_id FROM cte)
		    )
		GROUP BY 
		    dpname, c.c_process_class;
	</select>
	
	<select id="getGroupedDepartmentSum" parameterType="map" resultType="map">
		WITH RECURSIVE cte AS (
		    SELECT dp_id, dp_pid, dp_depth, dp_name
		    FROM department 
		    WHERE dp_id = #{dpId}
		    UNION ALL
		    SELECT a.dp_id, a.dp_pid, a.dp_depth, a.dp_name
		    FROM department AS a
		    INNER JOIN cte AS b ON b.dp_id = a.dp_pid
		)
		SELECT 
		    CASE 
		        WHEN d.dp_depth = 3 THEN (
		            SELECT dp_name 
		            FROM department 
		            WHERE dp_id = d.dp_pid
		        )
		        WHEN d.dp_depth = 2 THEN d.dp_name
		    END AS original_dpname,
		    CASE 
		        WHEN (
		            CASE 
		                WHEN d.dp_depth = 3 THEN (
		                    SELECT dp_name 
		                    FROM department 
		                    WHERE dp_id = d.dp_pid
		                )
		                WHEN d.dp_depth = 2 THEN d.dp_name
		            END
		        ) IN ('충장동', '동명동', '계림1동', '계림2동', '산수1동', '산수2동', '지산1동', '지산2동', '서남동', '학동', '학운동', '지원1동', '지원2동')
		        THEN '기타'
		        ELSE (
		            CASE 
		                WHEN d.dp_depth = 3 THEN (
		                    SELECT dp_name 
		                    FROM department 
		                    WHERE dp_id = d.dp_pid
		                )
		                WHEN d.dp_depth = 2 THEN d.dp_name
		            END
		        )
		    END AS dpname,
		    COUNT(*) AS cdpcount
		FROM 
		    complaint c
		JOIN 
		    department d ON c.dp_id = d.dp_id
		WHERE 
		    c.c_notificated IN (2, 9)
		    AND (
		        c.dp_id IN (SELECT dp_id FROM cte)
		        OR c.dp_id_01 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_02 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_03 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_04 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_05 IN (SELECT dp_id FROM cte)
		        OR c.dp_id_06 IN (SELECT dp_id FROM cte)
		    )
		GROUP BY 
		    dpname;
	</select>
		
	<update id="changePassword" parameterType="com.minwon.vo.UserVO">
		UPDATE user
		SET u_login_pwd=#{u_login_pwd}
		WHERE u_gpki_dn=#{u_gpki_dn}
	</update>
	
	<insert id="requestMember" parameterType="com.minwon.vo.MemberVO">
		INSERT INTO membership_app (u_name, dp_id, ps_id, u_grade, u_login_id, u_login_pwd, u_email, u_admin_num)
		VALUES (#{u_name}, #{dp_id}, #{ps_id},  #{u_grade}
		, #{u_login_id}, #{u_login_pwd}, #{u_email}, #{u_admin_num})
	</insert>
	
	<select id="getDpId" resultType="int" parameterType="String">
		SELECT dp_id FROM department where dp_name=#{department}
	</select>
	
	<select id="getPsId" resultType="int" parameterType="String">
		SELECT ps_id FROM position where ps_name=#{position}
	</select>
	
	<select id="getDn" parameterType="int" resultType="String">
		SELECT u_gpki_dn FROM user where u_id=#{id}
	</select>
	
	<update id="registerCertificate" parameterType="com.minwon.vo.UserVO">
		UPDATE user
		SET u_gpki_dn=#{u_gpki_dn}
		WHERE u_id=#{u_id}
	</update>
	
	<update id="updateSettle" parameterType="com.minwon.vo.ComplaintSettleVO">
		UPDATE complaint_settle
		SET cs_date=#{csDate}, cs_content=#{csContent}
		WHERE cs_id=#{csId}
	</update>
	
	<delete id="deleteSettle" parameterType="int">
		DELETE FROM complaint_settle
		WHERE cs_id=#{id}
	</delete>
	
	<delete id="deleteImage" parameterType="int">
		DELETE FROM complaint_image
		WHERE ci_id=#{id}
	</delete>
	
	<delete id="deleteFile" parameterType="int">
		DELETE FROM complaint_file
		WHERE cf_id=#{id}
	</delete>
	
	<delete id="deleteReply" parameterType="int">
		DELETE FROM complaint_reply
		WHERE cr_id=#{id}
	</delete>
	
	<update id="updatePlan" parameterType="com.minwon.vo.ComplaintVO">
		UPDATE complaint
		SET c_plan=#{cPlan}
		WHERE c_id=#{cId}
	</update>
	
	<update id="changeProcess" parameterType="com.minwon.vo.ComplaintVO">
		UPDATE complaint
		SET c_process_class=#{cProcessClass}
		WHERE c_id=#{cId}
	</update>
	
	<select id="processingComplaintsCount" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND c_process_class = '처리중'
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="finishedComplaintsCount" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND c_process_class = '처리완료'
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="reviewingComplaintsCount" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND c_process_class = '중장기검토'
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="cooperateComplaintsCount" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND c_process_class = '타기관협조'
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
	
	<select id="impossibleComplaintsCount" resultType="Integer">
		WITH recursive cte AS
		(
			SELECT dp_id, dp_pid FROM department WHERE dp_id=#{dpId}
			UNION ALL
			SELECT a.dp_id, a.dp_pid from department as a
			INNER JOIN cte AS b
			ON b.dp_id = a.dp_pid
		)
		SELECT count(*)
		FROM complaint 
		WHERE c_notificated IN (2, 9)
		AND c_process_class = '처리불가'
		AND (dp_id IN (SELECT dp_id FROM cte) or dp_id_01 IN (SELECT dp_id FROM cte) or dp_id_02 IN (SELECT dp_id FROM cte) or dp_id_03 IN (SELECT dp_id FROM cte) or dp_id_04 IN (SELECT dp_id FROM cte) or dp_id_05 IN (SELECT dp_id FROM cte) or dp_id_06 IN (SELECT dp_id FROM cte))
	</select>
</mapper>