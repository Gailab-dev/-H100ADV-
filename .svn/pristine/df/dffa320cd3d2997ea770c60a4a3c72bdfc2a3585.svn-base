package com.minwon.controller;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import com.minwon.service.AdminService;
import com.minwon.service.ArchiveService;
import com.minwon.service.CryptoAriaService;
import com.minwon.service.MainService;
import com.minwon.service.NoticeService;
import com.minwon.vo.ArchiveFileVO;
import com.minwon.vo.ArchiveVO;
import com.minwon.vo.ComplaintVO;
import com.minwon.vo.IpLogVO;
import com.minwon.vo.NoticeFileVO;
import com.minwon.vo.NoticeVO;
import com.minwon.vo.SearchVO;

@Controller
@RequestMapping("/admin/*")
public class AdminController {
	@Autowired
	MainService mainService;
	
	@Autowired
	AdminService adminService;
	
	@Autowired
	NoticeService noticeService;
	
	@Autowired
	ArchiveService archiveService;
	
	@Autowired
	CryptoAriaService cryptoAriaService;
	
	@RequestMapping("member_request.do")
	public String memberRequest() {
		return "admin/adm_member_request";
	}
	@RequestMapping("part.do")
	public String part() {
		return "admin/mang_part";
	}
	
	@RequestMapping("position.do")
	public String position() {
		return "admin/mang_position";
	}
	
	@RequestMapping("user.do")
	public String user() {
		return "admin/mang_user";
	}
	
	@RequestMapping("page_access.do")
	public String pageAccess() {
		return "admin/mang_page_access";
	}
	
	@RequestMapping("mw_list.do")
	public ModelAndView mwList(@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="uName")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO
			) throws Exception {
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
        searchVO.setKeyword(keyword);
		int complaintListCnt = adminService.getAllComplaintsCnt(searchVO);
		searchVO.pageInfo(page, range, complaintListCnt);
		List<ComplaintVO> allComplaintsList = adminService.getAllComplaints(searchVO);
		mav.setViewName("admin/mang_mw_list");
		mav.addObject("complaints", allComplaintsList);
		mav.addObject("pagination", searchVO);
		return mav;
	}
	
	@RequestMapping("mw_modi.do")
	public ModelAndView mwView(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		ModelAndView mav = new ModelAndView();
		ComplaintVO complaint = adminService.getComplaint(complaintId);
		complaint.setcPetitioner(cryptoAriaService.decryptData(complaint.getcPetitioner()));
		complaint.setcPetitionerPhone(cryptoAriaService.decryptData(complaint.getcPetitionerPhone()));
		complaint.setcPetitionerAddress(cryptoAriaService.decryptData(complaint.getcPetitionerAddress()));
		mav.setViewName("admin/mang_mw_modi");
		mav.addObject("complaint", complaint);
		return mav;
	}
	
	@RequestMapping(value="imsi_complaint.do", method=RequestMethod.GET)
	public String toImsiComplaint(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		adminService.updateToImsi(complaintId);
		return "redirect:/admin/mw_list.do";
	}
	
	@RequestMapping(value="non_complete_complaint.do", method=RequestMethod.GET)
	public String toNonCompleteComplaint(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		adminService.updateToNonComplete(complaintId);
		return "redirect:/admin/mw_list.do";
	}
	
	@RequestMapping(value="complete_complaint.do", method=RequestMethod.GET)
	public String toCompleteComplaint(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		adminService.updateToComplete(complaintId);
		return "redirect:/admin/mw_list.do";
	}
	
	@RequestMapping(value="temp_delete_complaint.do", method=RequestMethod.GET)
	public String tempDeleteComplaint(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		adminService.tempDeleteComplaint(complaintId);
		return "redirect:/admin/mw_list.do";
	}
	
	@RequestMapping("mw_delete.do")
	public ModelAndView mwDeleteList(@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="uName")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO
			) throws Exception {
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
        searchVO.setKeyword(keyword);
		int complaintListCnt = adminService.getTempDeletedComplaintsCnt(searchVO);
		searchVO.pageInfo(page, range, complaintListCnt);
		List<ComplaintVO> tempDeletedComplaints = adminService.getTempDeletedComplaints(searchVO);
		mav.setViewName("admin/mang_mw_delete");
		mav.addObject("pagination", searchVO);
		mav.addObject("deletedComplaints", tempDeletedComplaints);
		return mav;
	}
	
	@RequestMapping(value="mw_login_ip.do", method=RequestMethod.GET)
	public ModelAndView mwLoginIp(@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="uName")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO) throws Exception {
		ModelAndView mav = new ModelAndView();
		
		searchVO.setSearchType(searchType);
        searchVO.setKeyword(keyword);
        int logListCnt = adminService.getIpLogListCnt(searchVO);
        searchVO.pageInfo(page, range, logListCnt);
        System.out.println(searchVO.getPage());
        List<IpLogVO> ipLogList = adminService.getIpLogList(searchVO);
		mav.setViewName("admin/mang_login_ip");
		mav.addObject("ipLogList", ipLogList);
		mav.addObject("pagination", searchVO);
		return mav;
	}
	
	@RequestMapping("mw_ip_protect.do")
	public String mwIpProtect() {
		return "admin/mang_ip_protect";
	}
	
	@RequestMapping("mw_admin_setting.do")
	public String mwAdminSetting() {
		return "admin/mang_admin_setting";
	}
	
	@RequestMapping("changePassword.do")
	public String changePassword(HttpServletRequest request) throws Exception {
		String password = cryptoAriaService.encryptData(request.getParameter("password"));
		System.out.println(password);
		adminService.changePassword(password);
		return "redirect:/admin/mw_admin_setting.do";
	}
	
	@RequestMapping("initPassword.do")
	public String initPassword() throws Exception {
		String password = cryptoAriaService.encryptData("1qaz2wsx");
		adminService.initPassword(password);
		return "redirect:/admin/login.do";
	}
	
	@RequestMapping("mw_notice_list.do")
	public ModelAndView noticeList(@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO) throws Exception {
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
        searchVO.setKeyword(keyword);
        List<NoticeVO> noticeList = noticeService.getAllList(searchVO);
        int noticeListCnt = noticeService.getAllListCnt(searchVO);
        searchVO.pageInfo(page, range, noticeListCnt);
        for (int i = 0; i < noticeList.size(); i++) {
			Date now = noticeList.get(i).getN_writedate();
			SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
			String formattedDate = format.format(now);
			noticeList.get(i).setDate(formattedDate);
		}
		mav.setViewName("admin/mang_notice_list");
		mav.addObject("noticeList", noticeList);
		mav.addObject("pagination", searchVO);
		return mav;
	}
	
	@RequestMapping("mw_archive_list.do")
	public ModelAndView archiveList(@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO) throws Exception {
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
        searchVO.setKeyword(keyword);
        List<ArchiveVO> archiveList = archiveService.getAllList(searchVO);
        int archiveListCnt = noticeService.getAllListCnt(searchVO);
        searchVO.pageInfo(page, range, archiveListCnt);
        for (int i = 0; i < archiveList.size(); i++) {
			Date now = archiveList.get(i).getA_writedate();
			SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
			String formattedDate = format.format(now);
			archiveList.get(i).setDate(formattedDate);
		}
		mav.setViewName("admin/mang_archive_list");
		mav.addObject("archiveList", archiveList);
		mav.addObject("pagination", searchVO);
		return mav;
	}
	
	@RequestMapping("mw_notice_view.do")
	public ModelAndView noticeView(@RequestParam(required=false, value="id") Integer noticeId) throws Exception {
		ModelAndView mav = new ModelAndView();
		NoticeVO notice = noticeService.getNotice(noticeId);
		List<NoticeFileVO> noticeFiles = noticeService.getNoticeFiles(noticeId);
		mav.setViewName("admin/mang_notice_view");
		mav.addObject("notice", notice);
		mav.addObject("noticeFiles", noticeFiles);
		return mav;
	}
	
	@RequestMapping("mw_notice_update.do")
	public String noticeUpdate(@ModelAttribute NoticeVO vo) throws Exception {
		noticeService.updateNotice(vo);
		return "redirect:/admin/mw_notice_view.do?id=" + vo.getN_id();
	}
	
	@RequestMapping("mw_notice_delete.do")
	public String noticeDelete(@RequestParam(required=false, value="id") Integer noticeId) throws Exception {
		noticeService.deleteNoticeFiles(noticeId);
		noticeService.deleteNotice(noticeId);
		return "redirect:/admin/mw_notice_list.do";
	}
	
	@RequestMapping("mw_archive_view.do")
	public ModelAndView archiveView(@RequestParam(required=false, value="id") Integer archiveId) throws Exception {
		ModelAndView mav = new ModelAndView();
		ArchiveVO archive = archiveService.getArchive(archiveId);
		List<ArchiveFileVO> archiveFiles = archiveService.getArchiveFiles(archiveId);
		mav.setViewName("admin/mang_archive_view");
		mav.addObject("archive", archive);
		mav.addObject("archiveFiles", archiveFiles);
		return mav;
	}
	
	@RequestMapping("mw_archive_update.do")
	public String archiveUpdate(@ModelAttribute ArchiveVO vo) throws Exception {
		archiveService.updateArchive(vo);
		return "redirect:/admin/mw_archive_view.do?id=" + vo.getA_id();
	}
	
	@RequestMapping("mw_archive_delete.do")
	public String archiveDelete(@RequestParam(required=false, value="id") Integer archiveId) throws Exception {
		archiveService.deleteArchiveFiles(archiveId);
		archiveService.deleteArchive(archiveId);
		return "redirect:/admin/mw_archive_list.do";
	}
	
	@RequestMapping("mw_restore.do")
	public String restoreMinwon(@RequestParam(required=false, value="id") int id) throws Exception {
		adminService.restoreMinwon(id);
		return "redirect:/admin/mw_delete.do";
	}
}
