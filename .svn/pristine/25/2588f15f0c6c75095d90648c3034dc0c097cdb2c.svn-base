package com.minwon.controller;

import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.sql.Blob;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;

import javax.imageio.ImageIO;
import javax.mail.Session;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.codec.binary.Base64;
import org.apache.commons.io.FilenameUtils;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.BorderStyle;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.usermodel.FillPatternType;
import org.apache.poi.ss.usermodel.IndexedColors;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.imgscalr.Scalr;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import com.dsjdf.jdf.Logger;
import com.minwon.service.AllService;
import com.minwon.service.CryptoAriaService;
import com.minwon.service.MainService;
import com.minwon.vo.ComplaintFileVO;
import com.minwon.vo.ComplaintImageVO;
import com.minwon.vo.ComplaintReplyVO;
import com.minwon.vo.ComplaintSettleVO;
import com.minwon.vo.ComplaintVO;
import com.minwon.vo.MemberVO;
import com.minwon.vo.Pagination;
import com.minwon.vo.SearchVO;

@Controller
@RequestMapping("/main/*")
public class MainController {
	@Autowired
	MainService mainService;
	
	@Autowired
	AllService allService;
	
	@Autowired
	CryptoAriaService cryptoAriaService;
	
	@RequestMapping(value="memberRequest.do", method=RequestMethod.POST)
	public String memberRequest(@ModelAttribute MemberVO vo, HttpServletRequest request) throws Exception {
		int uGrade;
		int dpId = mainService.getDpId((String) request.getParameter("department"));
		int psId = mainService.getPsId((String) request.getParameter("position"));
		if (psId == 1 || psId == 2) uGrade = 9;
		else if (psId == 3) uGrade = 3;
		else if (psId == 4) uGrade = 2;
		else uGrade = 1;
		vo.setDp_id(dpId);
		vo.setPs_id(psId);
		vo.setU_grade(uGrade);
		vo.setU_login_pwd(cryptoAriaService.encryptData((String) request.getParameter("u_login_pwd")));
		
		mainService.requestMember(vo);
		return "redirect:/main/login.do";
	}
	
	@RequestMapping("mw_insert.do")
	public ModelAndView insertMinwonPage(HttpServletRequest request) throws Exception {
		HttpSession session = request.getSession();
		System.out.println(session.getAttribute("userId"));
		String department = mainService.getDepartment((int) session.getAttribute("userDpId"));
		List<String> relatedDepartments = mainService.getRelatedDepartments();
		List<String> relatedDepartments2 = mainService.getRelatedDepartments2();
		String departmentBoss = mainService.getDepartmentBoss((int) session.getAttribute("userDpId"));
		String parentDepartmentBoss = mainService.getParentDepartmentBoss((int) session.getAttribute("userDpId"));
		System.out.println(departmentBoss);
		System.out.println(parentDepartmentBoss);
		System.out.println("사용자등급" + session.getAttribute("userGrade"));
		ModelAndView mav = new ModelAndView();
		mav.setViewName("main/mw_insert");
		mav.addObject("department", department);
		mav.addObject("relatedDepartments", relatedDepartments);
		mav.addObject("relatedDepartments2", relatedDepartments2);
		mav.addObject("departmentBoss", departmentBoss);
		mav.addObject("parentDepartmentBoss", parentDepartmentBoss);
		return mav;
	}
	
	@RequestMapping(value="mw_insert_excel.do")
	public ModelAndView insertMinwonExcel(HttpServletRequest request
			,@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range) throws Exception {
		HttpSession session = request.getSession();
		Pagination pagination = new Pagination();
		ModelAndView mav = new ModelAndView();
		int uId = (int) session.getAttribute("userId");
		List<ComplaintVO> excelComplaints = mainService.getComplaintsExcel(uId); 
		for (ComplaintVO excelComplaint : excelComplaints) {
			excelComplaint.setcPetitioner(cryptoAriaService.decryptData(excelComplaint.getcPetitioner()));
			excelComplaint.setcPetitionerPhone(cryptoAriaService.decryptData(excelComplaint.getcPetitionerPhone()));
			excelComplaint.setcPetitionerAddress(cryptoAriaService.decryptData(excelComplaint.getcPetitionerAddress()));
		}
		int excelComplaintsCnt = excelComplaints.size();
		pagination.pageInfo(page, range, excelComplaintsCnt);
		mav.setViewName("main/mw_insert_excel");
		mav.addObject("excelComplaints", excelComplaints);
		mav.addObject("pagination", pagination);
		return mav;
	}
	
	@RequestMapping(value="insert_complaint_excel.do")
	public String insertExcel(@RequestParam("excelFile") MultipartFile file, Model model, HttpServletRequest request) throws Exception {
		HttpSession session = request.getSession();
		String department = mainService.getDepartment((int) session.getAttribute("userDpId"));
		List<ComplaintVO> dataList = new ArrayList<>();
		String extension = FilenameUtils.getExtension(file.getOriginalFilename());
		if (!extension.equals("xlsx") && !extension.equals("xls")) {
			throw new IOException("엑셀 파일만 업로드 해주세요.");
		}
		Workbook workbook = null;
		if (extension.equals("xlsx")) {
			workbook = new XSSFWorkbook(file.getInputStream());
		} else if (extension.equals("xls")) {
			workbook = new HSSFWorkbook(file.getInputStream());
		}
		Sheet worksheet = workbook.getSheetAt(0);
		for (int i = 2; i < worksheet.getPhysicalNumberOfRows(); i++) {
			Row row = worksheet.getRow(i);
			if (row.getCell(0).getStringCellValue().equals("")) {
				break;
			}
			ComplaintVO data = new ComplaintVO();
			data.setuId((int)session.getAttribute("userId"));
			data.setDpId((int)session.getAttribute("userDpId"));
			data.setcTitle(row.getCell(0).getStringCellValue());
			data.setcAddress(row.getCell(1).getStringCellValue());
			data.setcDistrict(row.getCell(2).getStringCellValue());
			if (row.getCell(3).getCellType() != Cell.CELL_TYPE_BLANK) {
				data.setcPetitioner(cryptoAriaService.encryptData(row.getCell(3).getStringCellValue()));
			} else {
				data.setcPetitioner(cryptoAriaService.encryptData("없음"));
			}
			if (row.getCell(4).getCellType() != Cell.CELL_TYPE_BLANK) {
				data.setcPetitionerPhone(cryptoAriaService.encryptData(row.getCell(4).getStringCellValue()));
			} else {
				data.setcPetitionerPhone(cryptoAriaService.encryptData("없음"));
			}
			if (row.getCell(5).getCellType() != Cell.CELL_TYPE_BLANK) {
				data.setcPetitionerAddress(cryptoAriaService.encryptData(row.getCell(5).getStringCellValue()));
			} else {
				data.setcPetitionerAddress(cryptoAriaService.encryptData("없음"));
			}
			System.out.println(row.getCell(4).getCellType() == Cell.CELL_TYPE_BLANK);
			data.setcPetitionerSpecific(row.getCell(6).getStringCellValue());
			data.setcReceiptDate(row.getCell(7).getStringCellValue());
			data.setcReceiptWay(row.getCell(8).getStringCellValue());
			data.setcRaiseDate(row.getCell(9).getStringCellValue());
			data.setcRaiseCount((int)row.getCell(10).getNumericCellValue());
			data.setcDepartment(department);
			data.setcOfficer01(row.getCell(11).getStringCellValue());
			data.setcOfficer02(row.getCell(12).getStringCellValue());
			data.setDpName01(row.getCell(13).getStringCellValue());
			data.setDpName02(row.getCell(14).getStringCellValue());
			data.setDpName03(row.getCell(15).getStringCellValue());
			data.setDpName04(row.getCell(16).getStringCellValue());
			// data.setcKeyPoint(row.getCell(17).getStringCellValue());
			data.setcContent(row.getCell(17).getStringCellValue());
			data.setcPlan(row.getCell(18).getStringCellValue());
			data.setcOfficer03(session.getAttribute("userName").toString());
			data.setcAdminNum(session.getAttribute("userAdminNum").toString());
			mainService.insertComplaintExcel(data);
		}
		return "redirect:/main/mw_insert_excel.do";
	}
	
	@RequestMapping("mw_insert_temp_list.do")
	public ModelAndView tempMinwonList(HttpServletRequest request) throws Exception {
		ModelAndView mav = new ModelAndView();
		HttpSession session = request.getSession();
		int uId = (int) session.getAttribute("userId");
		List<ComplaintVO> tempComplaints = mainService.getTempComplaints(uId);
		
		mav.setViewName("main/mw_insert_temp_list");
		mav.addObject("tempComplaints", tempComplaints);
		return mav;
	}
	
	@RequestMapping("mw_insert_temp_view.do")
	public ModelAndView tempMinwon(HttpServletRequest request, @RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		ModelAndView mav = new ModelAndView();
		HttpSession session = request.getSession();
		ComplaintVO tempComplaint = mainService.getTempComplaint(complaintId);
		System.out.println(cryptoAriaService.decryptData(tempComplaint.getcPetitionerPhone()));
		tempComplaint.setcPetitioner(cryptoAriaService.decryptData(tempComplaint.getcPetitioner()));
		tempComplaint.setcPetitionerPhone(cryptoAriaService.decryptData(tempComplaint.getcPetitionerPhone()));
		tempComplaint.setcPetitionerAddress(cryptoAriaService.decryptData(tempComplaint.getcPetitionerAddress()));
		List<String> relatedDepartments2 = mainService.getRelatedDepartments2();
		List<String> relatedDepartments = mainService.getRelatedDepartments();
		String department = mainService.getDepartment((int) session.getAttribute("userDpId"));
		System.out.println(tempComplaint.getcAnswer());
		mav.setViewName("main/mw_insert_temp_view");
		mav.addObject("tempComplaint", tempComplaint);
		mav.addObject("complaintSettles", mainService.getComplaintSettles(complaintId));
		mav.addObject("complaintImages", mainService.getComplaintImages(complaintId));
		mav.addObject("complaintReplies", mainService.getComplaintReplies(complaintId));
		mav.addObject("complaintFiles", mainService.getComplaintFiles(complaintId));
		mav.addObject("relatedDepartments", relatedDepartments);
		mav.addObject("relatedDepartments2", relatedDepartments2);
		mav.addObject("complaintId", complaintId);
		mav.addObject("department", department);
		return mav;
	}
	
	@RequestMapping(value="insert_complaint.do", method=RequestMethod.POST)
	public String insertMinwon(@ModelAttribute ComplaintVO vo, HttpServletRequest request) {
		HttpSession session = request.getSession();
		vo.setcPetitioner(cryptoAriaService.encryptData(vo.getcPetitioner()));
		vo.setcPetitionerPhone(cryptoAriaService.encryptData(vo.getcPetitionerPhone()));
		vo.setcPetitionerAddress(cryptoAriaService.encryptData(vo.getcPetitionerAddress()));
		vo.setcAdminNum(session.getAttribute("userAdminNum").toString());
		mainService.insertComplaint(vo);
		System.out.println(vo.getcDepartment());
		return "redirect:/main/mw_insert_temp_list.do";
	}
	
	@RequestMapping(value="register_complaint.do", method=RequestMethod.POST)
	public String registerMinwon(@ModelAttribute ComplaintVO vo, HttpServletRequest request) throws Exception {
		HttpSession session = request.getSession();
		vo.setcPetitioner(cryptoAriaService.encryptData(vo.getcPetitioner()));
		vo.setcPetitionerPhone(cryptoAriaService.encryptData(vo.getcPetitionerPhone()));
		vo.setcPetitionerAddress(cryptoAriaService.encryptData(vo.getcPetitionerAddress()));
		vo.setcAdminNum(session.getAttribute("userAdminNum").toString());
		mainService.registerComplaint(vo);
		return "redirect:/main/main.do";
	}
	
	@RequestMapping(value="insert_complaint_settle.do", method=RequestMethod.POST)
	public String insertMinwonSettle(@ModelAttribute ComplaintSettleVO vo, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		System.out.println(vo);
		mainService.insertComplaintSettle(vo);
		return "redirect:/main/" + viewName + ".do?id=" + vo.getcId() + "#div3";
	}
	
	@RequestMapping(value="insert_complaint_image.do", method=RequestMethod.POST)
	public String insertMinwonImage(@ModelAttribute ComplaintImageVO vo, MultipartFile imageFile, HttpServletRequest request, HashMap<String, Object> param, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		// String saveDir = request.getSession().getServletContext().getRealPath("/resources/upload/images/");
//	    String saveDir = "/home/upload/images/";
		 String saveDir = "C:/static/upload/images/";
		UUID uuid = UUID.randomUUID();
		String savedFileName = uuid.toString() + ".jpg";
		String fileUploadUrl = saveDir + savedFileName;
		BufferedImage bi = ImageIO.read(imageFile.getInputStream());
		bi = resizeImage(bi, 1280, 720);
		ImageIO.write(bi, "jpg", new File(fileUploadUrl));
		vo.setCiImage(savedFileName);
		param.put("cId", vo.getcId());
		param.put("uId", vo.getuId());
		param.put("dpName", vo.getDpName());
		param.put("psName", vo.getPsName());
		param.put("uName", vo.getuName());
		param.put("ciContent", vo.getCiContent());
		param.put("ciImage", vo.getCiImage());
		/*
		 * String saveName = imageFile.getOriginalFilename();
		System.out.println(vo);
		File saveFile = new File(saveDir, saveName); 
		System.out.println(1);
		SimpleDateFormat formatter= new SimpleDateFormat("yyyyMMddHHmmssSSS");
    	Date date = new Date();
    	String now = formatter.format(date);
    	File savedFile = new File(saveDir + now + ".jpg");
    	System.out.println(2);
    	boolean savingFile = saveFile.renameTo(savedFile);
    	
    	if (imageFile != null && !imageFile.isEmpty()) {
            try {
                imageFile.transferTo(savedFile);  
                vo.setCiImage(now + ".jpg");
            } catch (Exception e) {
                throw new RuntimeException("도서 이미지 업로드가 실패하였습니다", e);
            }
        }
		 * 
		 * */
		
    	
    	mainService.insertComplaintImage(param);
		
		return "redirect:/main/" + viewName + ".do?id=" + vo.getcId() + "#div4";
	}
	
	BufferedImage resizeImage(BufferedImage originalImage, int targetWidth, int targetHeight) throws Exception {
		return Scalr.resize(originalImage, Scalr.Method.AUTOMATIC, Scalr.Mode.FIT_EXACT, targetWidth, targetHeight, Scalr.OP_ANTIALIAS);
	}
	
	@RequestMapping(value="insert_complaint_file.do", method=RequestMethod.POST)
	public String insertMinwonFile(@ModelAttribute ComplaintFileVO vo, MultipartFile textFile, HttpServletRequest request, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		// String saveDir = request.getSession().getServletContext().getRealPath("/resources/upload/files/");
		String saveDir = "/home/upload/files/";
		System.out.println(saveDir);
		String saveName = textFile.getOriginalFilename();
		System.out.println(vo);
		File saveFile = new File(saveDir, saveName); 
    	System.out.println(2);
    	
    	if (textFile != null && !textFile.isEmpty()) {
            try {
                textFile.transferTo(saveFile);  
                vo.setCfFileLogic(saveName);
            } catch (Exception e) {
                throw new RuntimeException("파일 업로드가 실패하였습니다", e);
            }
        }
    	
    	mainService.insertComplaintFile(vo);
		
		return "redirect:/main/" + viewName +".do?id=" + vo.getcId() + "#div4";
	}
	
	@RequestMapping(value="insert_complaint_reply.do", method=RequestMethod.POST)
	public String insertMinwonReply(@ModelAttribute ComplaintReplyVO vo, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		mainService.insertComplaintReply(vo);
		return "redirect:/main/" + viewName + ".do?id=" + vo.getcId() + "#div5";
	}
	
	@RequestMapping(value="insert_complaint_reply_completed.do", method=RequestMethod.POST)
	public String insertMinwonReplyCompleted(@ModelAttribute ComplaintReplyVO vo) throws Exception {
		mainService.insertComplaintReply(vo);
		return "redirect:/main/mw_completed_view.do?id=" + vo.getcId() + "#div5";
	}
	
	@RequestMapping(value="insert_complaint_reply_not.do", method=RequestMethod.POST)
	public String insertMinwonReplyNotCompleted(@ModelAttribute ComplaintReplyVO vo) throws Exception {
		mainService.insertComplaintReply(vo);
		return "redirect:/main/mw_not_completed_view.do?id=" + vo.getcId() + "#div5";
	}
	
	@RequestMapping(value="update_temp_complaint.do", method=RequestMethod.POST)
	public String updateTempMinwon(@ModelAttribute ComplaintVO vo) throws Exception {
		vo.setcPetitioner(cryptoAriaService.encryptData(vo.getcPetitioner()));
		vo.setcPetitionerPhone(cryptoAriaService.encryptData(vo.getcPetitionerPhone()));
		vo.setcPetitionerAddress(cryptoAriaService.encryptData(vo.getcPetitionerAddress()));
		System.out.println("왜안되넌겨" + vo.getcDepartment());
		mainService.updateTempComplaint(vo);
		return "redirect:/main/mw_insert_temp_list.do";
	}
	
	@RequestMapping(value="update_complaint.do", method=RequestMethod.POST)
	public String updateMinwon(@ModelAttribute ComplaintVO vo) throws Exception {
		vo.setcPetitioner(cryptoAriaService.encryptData(vo.getcPetitioner()));
		vo.setcPetitionerPhone(cryptoAriaService.encryptData(vo.getcPetitionerPhone()));
		vo.setcPetitionerAddress(cryptoAriaService.encryptData(vo.getcPetitionerAddress()));
		if (vo.getcProcessClass().equals("처리완료")) {
			vo.setcNotificated(9);
		} else {
			vo.setcNotificated(2);
		}
		
		System.out.println("부서명 : " + vo.getcDepartment());
		mainService.updateTempComplaint(vo);
		
		return "redirect:/main/mw_process_view.do?id=" + vo.getcId();
	}
	
	@RequestMapping(value="update_separation_type.do", method=RequestMethod.POST)
	public String updateSeparationType(@ModelAttribute ComplaintVO vo) throws Exception {
		mainService.updateSeparationType(vo);
		return "redirect:/main/mw_process_view.do?id=" + vo.getcId();
	}
	
//	@RequestMapping(value="update_process_complaint.do", method=RequestMethod.POST)
//	public String updateProcessMinwon(@ModelAttribute ComplaintVO vo) throws Exception {
//		mainService.updateProcessComplaint(vo);
//		mainService.completeComplaint(vo.getcId());
//		return "redirect:/main/mw_completed_list.do";
//	}
	
	@RequestMapping(value="update_process_complaint.do", method=RequestMethod.POST)
	public String updateProcessMinwon(@ModelAttribute ComplaintVO vo, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		mainService.updateProcessComplaint(vo);
		return "redirect:/main/" + viewName + ".do?id=" + vo.getcId() + "#div2";
	}
	
	@RequestMapping(value="process_complaint.do", method=RequestMethod.GET)
	public String processMinwon(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		mainService.processComplaint(complaintId);
		return "redirect:/main/mw_insert_temp_list.do";
	}
	
	@RequestMapping(value="complete_complaint.do", method=RequestMethod.GET)
	public String completeMinwon(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		mainService.completeComplaint(complaintId);
		return "redirect:/main/mw_completed_list.do";
	}
	
	@RequestMapping(value="delete_excel_complaint.do", method=RequestMethod.POST)
	public String deleteExcelMinwon(@RequestParam HashMap<String, Object> commandMap) throws NumberFormatException, Exception {
		String[] code_array = null;
		String code = commandMap.get("arrayParam").toString();
		code_array = code.split(",");
		System.out.println(code_array);
		for (int i = 0; i < code_array.length; i++) {
			if (code_array[i] == "") continue;
			mainService.deleteExcelComplaint(Integer.parseInt(code_array[i]));
		}
		return "redirect:/main/mw_insert_excel.do";
	}
	
	@RequestMapping(value="process_excel_complaints.do", method=RequestMethod.POST)
	public String processExcelMinwons(@RequestParam HashMap<String, Object> commandMap) throws NumberFormatException, Exception {
		String[] code_array = null;
		String code = commandMap.get("arrayParam").toString();
		code_array = code.split(",");
		System.out.println(code_array);
		for (int i = 0; i < code_array.length; i++) {
			if (code_array[i] == "") continue;
			mainService.processExcelComplaint(Integer.parseInt(code_array[i]));
		}
		return "redirect:/main/mw_insert_temp_list.do";
	}
	
	@RequestMapping(value="process_complaints.do", method=RequestMethod.POST)
	public String processMinwons(@RequestParam HashMap<String, Object> commandMap) throws NumberFormatException, Exception {
		String[] code_array = null;
		String code = commandMap.get("arrayParam").toString();
		code_array = code.split(",");
		System.out.println(code_array);
		for (int i = 0; i < code_array.length; i++) {
			if (code_array[i] == "") continue;
			mainService.processComplaint(Integer.parseInt(code_array[i]));
		}
		return "redirect:/main/mw_insert_temp_list.do";
	}
	
	@RequestMapping(value="delete_complaint.do", method=RequestMethod.POST)
	public String deleteMinwon(@RequestParam HashMap<String, Object> commandMap) throws NumberFormatException, Exception {
		String[] code_array = null;
		String code = commandMap.get("arrayParam").toString();
		code_array = code.split(",");
		System.out.println(code_array);
		for (int i = 0; i < code_array.length; i++) {
			if (code_array[i] == "") continue;
			mainService.deleteComplaint(Integer.parseInt(code_array[i]));
		}
		return "redirect:/main/mw_insert_temp_list.do";
	}
	
	@RequestMapping(value="mw_process_list.do")
	public ModelAndView minwonProcessList(HttpServletRequest request,
			HttpServletResponse response
			,@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO) throws Exception {
		HttpSession session = request.getSession();
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
		searchVO.setKeyword(keyword);
		searchVO.setDpId((int) session.getAttribute("userDpId"));
		searchVO.setuId((int) session.getAttribute("userId"));
		
		int processComplaintList;
		int complaintCnt;
		if ((int) session.getAttribute("userGrade") != 9) {
			searchVO.setDpId((int) session.getAttribute("userDpId"));
			searchVO.setuId((int) session.getAttribute("userId"));
			processComplaintList = mainService.getProcessListCnt(searchVO);
			complaintCnt = mainService.processComplaintCnt((int) session.getAttribute("userDpId"));
		} else {
			searchVO.setDpId(1);
			processComplaintList = allService.getProcessListCnt(searchVO);
			complaintCnt = allService.processComplaintCnt();
		}
		searchVO.pageInfo(page, range, processComplaintList);
		List<ComplaintVO> processList = mainService.getProcessList(searchVO);
		System.out.println(processComplaintList);
		for (ComplaintVO processComplaint : processList) {
			processComplaint.setcPetitioner(cryptoAriaService.decryptData(processComplaint.getcPetitioner()));
		}
		mav.setViewName("main/mw_process_list");
		mav.addObject("processList", processList);
		mav.addObject("pagination", searchVO);
		mav.addObject("complaintCnt", processComplaintList);
		return mav;
	}
	
	@RequestMapping(value="mw_process_view.do")
	public ModelAndView minwonProcessView(@RequestParam(required=false, value="id") Integer complaintId, HttpServletRequest request) throws Exception {
		ModelAndView mav = new ModelAndView();
		HttpSession session = request.getSession();
		List<String> relatedDepartments = mainService.getRelatedDepartments();
		List<String> relatedDepartments2 = mainService.getRelatedDepartments2();
		String department = mainService.getDepartment((int) session.getAttribute("userDpId"));
		List<ComplaintImageVO> images = mainService.getComplaintImages(complaintId);
		ComplaintVO processComplaint = mainService.getComplaint(complaintId);
		processComplaint.setcPetitioner(cryptoAriaService.decryptData(processComplaint.getcPetitioner()));
		processComplaint.setcPetitionerPhone(cryptoAriaService.decryptData(processComplaint.getcPetitionerPhone()));
		processComplaint.setcPetitionerAddress(cryptoAriaService.decryptData(processComplaint.getcPetitionerAddress()));
		
		mav.setViewName("main/mw_process_view");
		mav.addObject("processComplaint", processComplaint);
		mav.addObject("complaintSettles", mainService.getComplaintSettles(complaintId));
		mav.addObject("complaintImages", mainService.getComplaintImages(complaintId));
		mav.addObject("complaintReplies", mainService.getComplaintReplies(complaintId));
		mav.addObject("complaintFiles", mainService.getComplaintFiles(complaintId));
		mav.addObject("relatedDepartments", relatedDepartments);
		mav.addObject("relatedDepartments2", relatedDepartments2);
		mav.addObject("department", department);
		return mav;
	}
	
	@RequestMapping(value="mw_all_list.do")
	public ModelAndView minwonAllList(HttpServletRequest request
			,@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@RequestParam(required=false)String searchType2
            ,@RequestParam(required=false)String keyword2
            ,@ModelAttribute("search")SearchVO searchVO
			) throws Exception {
		HttpSession session = request.getSession();
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
		searchVO.setKeyword(keyword);
		searchVO.setSearchType2(searchType2);
		searchVO.setKeyword2(keyword2);
		if ((int) session.getAttribute("userGrade") != 9) {
			searchVO.setDpId((int) session.getAttribute("userDpId"));
			searchVO.setuId((int) session.getAttribute("userId"));
		} else {
			searchVO.setDpId(1);
			searchVO.setuId(1);
		}
		int allComplaintList = mainService.getAllListCnt(searchVO);
		int allComplaintCnt = mainService.allComplaintCnt((int) session.getAttribute("userDpId"));
		searchVO.pageInfo(page, range, allComplaintList);
		List<ComplaintVO> allList = mainService.getAllList(searchVO);
		for (ComplaintVO complaint : allList) {
			complaint.setcPetitioner(cryptoAriaService.decryptData(complaint.getcPetitioner()));
		}
		System.out.println(allList.size());
		mav.setViewName("main/mw_all_list");
		mav.addObject("allList", allList);
		mav.addObject("pagination", searchVO);
		mav.addObject("allComplaintCnt", allComplaintList);
		return mav;
	}
	
	@RequestMapping(value="mw_completed_list.do")
	public ModelAndView minwonCompletedList(HttpServletRequest request
			,@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false)String startDate
            ,@RequestParam(required=false)String endDate
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO
			) throws Exception {
		HttpSession session = request.getSession();
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
		searchVO.setKeyword(keyword);
		searchVO.setDpId((int) session.getAttribute("userDpId"));
		searchVO.setuId((int) session.getAttribute("userId"));
		searchVO.setStartDate(startDate);
		searchVO.setEndDate(endDate);
		int completeComplaintList;
		int complaintCnt;
		if ((int) session.getAttribute("userGrade") != 9) {
			searchVO.setDpId((int) session.getAttribute("userDpId"));
			searchVO.setuId((int) session.getAttribute("userId"));
			completeComplaintList = mainService.getCompletedListCnt(searchVO);
			complaintCnt = mainService.processCompletedComplaintCnt((int) session.getAttribute("userDpId"));
		} else {
			searchVO.setDpId(1);
			completeComplaintList = allService.getCompletedListCnt(searchVO);
			complaintCnt = allService.processComplaintCnt();
		}
		searchVO.pageInfo(page, range, completeComplaintList);
		List<ComplaintVO> completedList = mainService.getCompletedList(searchVO);
		for (ComplaintVO completedComplaint : completedList) {
			completedComplaint.setcPetitioner(cryptoAriaService.decryptData(completedComplaint.getcPetitioner()));
		}
		mav.setViewName("main/mw_completed_list");
		mav.addObject("completedList", completedList);
		mav.addObject("pagination", searchVO);
		mav.addObject("complaintCnt", completeComplaintList);
		return mav;
	}
	
	@RequestMapping(value="mw_completed_view.do")
	public ModelAndView minwonCompletedView(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		ModelAndView mav = new ModelAndView();
		ComplaintVO processComplaint = mainService.getComplaint(complaintId);
		processComplaint.setcPetitioner(cryptoAriaService.decryptData(processComplaint.getcPetitioner()));
		processComplaint.setcPetitionerPhone(cryptoAriaService.decryptData(processComplaint.getcPetitionerPhone()));
		processComplaint.setcPetitionerAddress(cryptoAriaService.decryptData(processComplaint.getcPetitionerAddress()));
		mav.setViewName("main/mw_completed_view");
		mav.addObject("processComplaint", processComplaint);
		mav.addObject("complaintSettles", mainService.getComplaintSettles(complaintId));
		mav.addObject("complaintImages", mainService.getComplaintImages(complaintId));
		mav.addObject("complaintFiles", mainService.getComplaintFiles(complaintId));
		mav.addObject("complaintReplies", mainService.getComplaintReplies(complaintId));
		return mav;
	}
	
	@RequestMapping(value="mw_not_completed_list.do")
	public ModelAndView minwonNotCompletedList(HttpServletRequest request
			,@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false)String startDate
            ,@RequestParam(required=false)String endDate
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO
			) throws Exception {
		HttpSession session = request.getSession();
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
		searchVO.setKeyword(keyword);
		searchVO.setDpId((int) session.getAttribute("userDpId"));
		searchVO.setuId((int) session.getAttribute("userId"));
		searchVO.setStartDate(startDate);
		searchVO.setEndDate(endDate);
		int processComplaintList;
		int complaintCnt;
		if ((int) session.getAttribute("userGrade") != 9) {
			searchVO.setDpId((int) session.getAttribute("userDpId"));
			searchVO.setuId((int) session.getAttribute("userId"));
			processComplaintList = mainService.getProcessListCnt(searchVO);
			complaintCnt = mainService.processComplaintCnt((int) session.getAttribute("userDpId"));
		} else {
			searchVO.setDpId(1);
			processComplaintList = allService.getProcessListCnt(searchVO);
			complaintCnt = allService.processComplaintCnt();
		}
		searchVO.pageInfo(page, range, processComplaintList);
		List<ComplaintVO> processList = mainService.getProcessList(searchVO);
		for (ComplaintVO processComplaint : processList) {
			processComplaint.setcPetitioner(cryptoAriaService.decryptData(processComplaint.getcPetitioner()));
		}
		mav.setViewName("main/mw_not_completed_list");
		mav.addObject("processList", processList);
		mav.addObject("pagination", searchVO);
		mav.addObject("keyword", keyword);
		mav.addObject("complaintCnt", processComplaintList);
		return mav;
	}
	
	@RequestMapping(value="mw_not_completed_view.do")
	public ModelAndView minwonNotCompletedView(@RequestParam(required=false, value="id") Integer complaintId) throws Exception {
		ModelAndView mav = new ModelAndView();
		ComplaintVO processComplaint = mainService.getComplaint(complaintId);
		processComplaint.setcPetitioner(cryptoAriaService.decryptData(processComplaint.getcPetitioner()));
		processComplaint.setcPetitionerPhone(cryptoAriaService.decryptData(processComplaint.getcPetitionerPhone()));
		processComplaint.setcPetitionerAddress(cryptoAriaService.decryptData(processComplaint.getcPetitionerAddress()));
		mav.setViewName("main/mw_not_completed_view");
		mav.addObject("processComplaint", processComplaint);
		mav.addObject("complaintSettles", mainService.getComplaintSettles(complaintId));
		mav.addObject("complaintImages", mainService.getComplaintImages(complaintId));
		mav.addObject("complaintFiles", mainService.getComplaintFiles(complaintId));
		mav.addObject("complaintReplies", mainService.getComplaintReplies(complaintId));
		return mav;
	}
	
	@RequestMapping(value="mw_reply_list.do")
	public ModelAndView minwonReplyList(HttpServletRequest request
			,@RequestParam(required=false,defaultValue="1")int page
            ,@RequestParam(required=false,defaultValue="1")int range
            ,@RequestParam(required=false,defaultValue="title")String searchType
            ,@RequestParam(required=false)String keyword
            ,@ModelAttribute("search")SearchVO searchVO
			) throws Exception {
		HttpSession session = request.getSession();
		ModelAndView mav = new ModelAndView();
		searchVO.setSearchType(searchType);
		searchVO.setKeyword(keyword);
		if ((int) session.getAttribute("userGrade") != 9) {
			searchVO.setDpId((int) session.getAttribute("userDpId"));
		} else {
			searchVO.setDpId(1);
		}
		int repliesCnt = mainService.getAllComplaintRepliesCnt(searchVO);
		searchVO.pageInfo(page, range, repliesCnt);
		mav.setViewName("main/mw_reply_list");
		mav.addObject("allReplies", mainService.getAllComplaintReplies(searchVO));
		mav.addObject("pagination", searchVO);
		return mav;
	}
	
	@RequestMapping(value="update_settle.do")
	public String updateSettle(HttpServletRequest request, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		ComplaintSettleVO vo = new ComplaintSettleVO();
		int cId = Integer.parseInt(request.getParameter("cId"));
		int csId = Integer.parseInt(request.getParameter("csId"));
		System.out.println(cId);
		String csDate = request.getParameter("csDate1");
		String csContent = request.getParameter("csContent1");
		vo.setCsId(csId);
		vo.setCsDate(csDate);
		vo.setCsContent(csContent);
		mainService.updateSettle(vo);
		return "redirect:/main/" + viewName +".do?id=" + cId + "#div3";
	}
	
	@RequestMapping(value="delete_settle.do")
	public String deleteSettle(HttpServletRequest request, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		int cId = Integer.parseInt(request.getParameter("cId"));
		int csId = Integer.parseInt(request.getParameter("csId"));
		mainService.deleteSettle(csId);
		return "redirect:/main/" + viewName + ".do?id=" + cId + "#div3";
	}
	
	@RequestMapping(value="delete_image.do")
	public String deleteImage(@RequestParam int id, @RequestParam int cId, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		mainService.deleteImage(id);
		return "redirect:/main/mw_process_view.do?id=" + cId + "#div4";
	}
	
	@RequestMapping(value="delete_file.do")
	public String deleteFile(@RequestParam int id, @RequestParam int cId, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		mainService.deleteFile(id);
		return "redirect:/main/mw_process_view.do?id=" + cId + "#div5";
	}
	
	@RequestMapping(value="delete_reply.do")
	public String deleteReply(@RequestParam int id, @RequestParam int cId, @RequestParam(value = "viewName", required = false) String viewName) throws Exception {
		mainService.deleteReply(id);
		return "redirect:/main/mw_process_view.do?id=" + cId + "#div6";
	}
	
	@RequestMapping(value="delete_temp_image.do")
	public String deleteTempImage(@RequestParam int id, @RequestParam int cId) throws Exception {
		mainService.deleteImage(id);
		return "redirect:/main/mw_insert_temp_view.do?id=" + cId + "#div4";
	}
	
	@RequestMapping(value="delete_temp_file.do")
	public String deleteTempFile(@RequestParam int id, @RequestParam int cId) throws Exception {
		mainService.deleteFile(id);
		return "redirect:/main/mw_insert_temp_view.do?id=" + cId + "#div5";
	}
	
	@RequestMapping(value="delete_temp_reply.do")
	public String deleteTempReply(@RequestParam int id, @RequestParam int cId) throws Exception {
		mainService.deleteReply(id);
		return "redirect:/main/mw_insert_temp_view.do?id=" + cId + "#div6";
	}
	
	@RequestMapping(value="delete_not_completed_reply.do")
	public String deleteNotCompletedReply(@RequestParam int id, @RequestParam int cId) throws Exception {
		mainService.deleteReply(id);
		return "redirect:/main/mw_not_completed_view.do?id=" + cId + "#div6";
	}
	
	@RequestMapping(value="delete_completed_reply.do")
	public String deleteCompletedReply(@RequestParam int id, @RequestParam int cId) throws Exception {
		mainService.deleteReply(id);
		return "redirect:/main/mw_completed_view.do?id=" + cId + "#div6";
	}
	
	@RequestMapping(value="update_plan.do", method=RequestMethod.POST)
	public String updatePlan(@ModelAttribute ComplaintVO vo) throws Exception {
		mainService.updatePlan(vo);
		return "redirect:/main/mw_process_view.do?id=" + vo.getcId();
	}
	
	@RequestMapping(value="change_process_class.do")
	public String changeProcessClass(@RequestParam int id, @RequestParam String process) throws Exception {
		ComplaintVO vo = new ComplaintVO();
		vo.setcId(id);
		vo.setcProcessClass(process);
		mainService.changeProcessClass(vo);
		return "redirect:/main/mw_completed_view.do?id=" + id;
	}
}
