<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>

<html lang="kr">
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">

<title>동구 종합민원이력관리시스템</title>
<link type="image/x-icon" rel="shortcut icon"
	href="${path}/resources/images/favicon.ico">
<%@ include file="../include/lib.jsp"%>

</head>

<body>
	<%@ include file="../include/header.jsp"%>

	<div class="container-fluid">
		<div class="row">
			<%@ include file="../include/nav.jsp"%>

			<main role="main"
				class="col-md-9 ml-sm-auto col-lg-10 d-flex flex-column"
				style="height: calc(100vh - 70px);">
				<div class="container">
					<div
						class=" d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
						<h1 class="h2">부서 등록</h1>
					</div>
					<div class="row">
						<div class="col-md-4 mb-4 border">
							<div id="tree"></div>
						</div>
						<div class="col-md-8">
							<div id="title_alert"
								class="alert alert-secondary d-flex align-items-center"
								role="alert">신규부서 등록중</div>
							<div class="tab-content" id="nav-tabContent">
								<div class="tab-pane fade show active" id="list-home"
									role="tabpanel" aria-labelledby="list-home-list">
									<div class=" order-md-1">
										<div class="mb-3">
											<label for="name">부서명<span class="text-muted"></span></label>
											<input type="text" class="form-control" id="name"
												placeholder="부서명을 입력해 주세요.">
										</div>
										<div class="mb-3 border border-info">
											<label for="parent">상위부서 선택<span class="text-muted"></span></label>
											<div class="row mb-3">
												<div class="col-md-2 m-1">0 단계</div>
												<div class="col-md-6">
													<select id="sele_0depth" class="form-control">
														<option value="0">동구청</option>
													</select>
												</div>
												<div class="col-md-3">
													<button class="btn btn-info btn-block" type="button"
														id="btn_0depth">선택</button>
												</div>
											</div>
											<div class="row mb-3">
												<div class="col-md-2  m-1">1 단계</div>
												<div class="col-md-6">
													<select id="sele_1depth" class="form-control">

													</select>
												</div>
												<div class="col-md-3">
													<button class="btn btn-info btn-block" type="button"
														id="btn_1depth">선택</button>
												</div>
											</div>
											<div class="row mb-3">
												<div class="col-md-2  m-1">2 단계</div>
												<div class="col-md-6">
													<select id="sele_2depth" class="form-control">

													</select>
												</div>
												<div class="col-md-3">
													<button class="btn btn-info btn-block" type="button"
														id="btn_2depth">선택</button>
												</div>
											</div>
										</div>
										<div class="row">
											<div class="col-md-5 mb-3">
												<label for="parent">상위부서<span class="text-muted"></span></label>
												<input type="text" class="form-control" id="parent"
													placeholder="" disabled />
											</div>
										</div>
										<label for="depth">부서단계</label>
										<div class="row mb-3">
											<div class="input-group col-md-5">
												<input id="depth" name="depth" class="form-control" disabled />

												<div class="input-group-append"></div>
											</div>
										</div>

										<div class="row">
											<div class="col-md-5 mb-3">
												<label for="rank">출력 순서</label> <input id="rank" type="text"
													class="form-control" placeholder="숫자" value="1">
											</div>
										</div>
										<hr class="mb-4">
										<div class="alert alert-danger" role="alert" id="alert">-</div>
										<div class="row">
											<div class="col-md-4 mb-3">
												<button class="btn btn-primary btn-block" type="submit"
													id="new">신규</button>
											</div>
											<div class="col-md-4 mb-3">
												<button class="btn btn-success btn-block" type="button"
													id="save">저장</button>
											</div>
											<div class="col-md-4 mb-3">
												<button class="btn btn-outline-danger btn-block"
													type="button" id="delete">삭제</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- footer start -->
				<%@ include file="../include/footer.jsp"%>
				<!-- footer end -->
			</main>
		</div>
	</div>
	<input type="hidden" id="h_new_check" value="new">
	<input type="hidden" id="h_prv_dp_depth">

	<input type="hidden" id="h_dp_id">
	<input type="hidden" id="h_dp_parent">
	<script>
		$(document).ready(function() {
			$.ajax({
				type : "POST",
				url : "/departmentList.do",
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				success : function(response) {

					var datas = new Array(); //jstree 용
					datas[0] = {
						id : 0,
						parent : '#',
						text : "동구청",
						depth : 0,
						rank : 1,
						state : {
							opened : true
						}
					};
					$.each(response, function(idx, item) {
						datas[idx + 1] = {
							id : item.dp_id,
							parent : item.dp_pid,
							text : item.dp_name,
							depth : item.dp_depth,
							rank : item.dp_rank,
							state : {
								opened : false
							}
						};
					});
					

					$('#tree').jstree({
						'core' : {
							'check_callback' : true,
							'data' : datas
						}
					}).bind("select_node.jstree", function(event, data) {
						var tree = $('#tree').jstree(true);
						var nodeId = data.node.id;
						var parentNode = tree.get_node(nodeId).parent;
						var parentNodeText = tree.get_node(parentNode).text;

						$('#title_alert').html(data.node.text+" 수정중 (상위부서 :"+parentNodeText+")");
						$('#h_new_check').val("modi");
						$('#h_dp_id').val(data.node.id);
						$('#h_prv_dp_depth').attr("value",data.node.original.depth);
						$('#h_dp_parent').attr("value",data.node.parent);
						$('#name').val(data.node.original.text);
						$('#depth').attr("value",data.node.original.depth);
						$('#parent').attr("value", parentNodeText);
						$('#rank').val(data.node.original.rank);
						
					});
					var data_sele = datas.slice();  //객체 복사
					data_sele.sort((x,y)=>x.text.localeCompare(y.text));  //이름순 정렬
					//console.log(data_sele);
					data_sele.forEach(function (element, index, array) {
						if(element.depth=="1"){
							var option = $("<option value=" + element.id + ">" + element.text+"</option>");
				            $('#sele_1depth').append(option);
						}else if(element.depth="2"){
							var option = $("<option value=" + element.id + ">" + element.text+"</option>");
				            $('#sele_2depth').append(option);
						}
					});
					

				}
			});
		});
	</script>
	<script>
	    //신규버튼
		$("#new").click(function() {
			NewData();
			
			/* console.log($('#h_new_check').val());  //진행현황
			console.log($('#h_prv_dp_depth').val()); //이전 등급 상황
			console.log($('#h_dp_id').val());   //수정&삭제용 dp_id
			console.log($('#h_dp_parent').val());  // 상위부서 ID값
			console.log($('#name').val());
			console.log($('#depth').val());
			console.log($('#parent').val());
			console.log($('#rank').val());
			alert(1); */
		});
		// 1depth 관련
		$("#btn_0depth").click(function() {
			// 1. new 선택 가능 2. modi시 prv_depth가 같은것이 아닐 경우 적용불가
			if($('#h_new_check').val()=="modi" && $('#h_prv_dp_depth').val() !="1") {
				$('#alert').html('같은 단계로만 이동이 가능합니다.');
				return;
			}
			// 1. 셀렉트바를 선택한 것을 부서단계&상위단계로 적용 
			
			$('#depth').attr("value", "1");			
			$('#parent').attr("value", "동구청");			
			$('#h_dp_parent').attr("value", "0");
			
		});
		// 2depth 관련
		$("#btn_1depth").click(function() {
			if($('#h_new_check').val()=="modi" && $('#h_prv_dp_depth').val() !="2") {
				$('#alert').html('같은 단계로만 이동이 가능합니다.');
				return;
			}	
			var parent_id = $("#sele_1depth option:selected").val();
			var parent_text =$("#sele_1depth option:selected").text();
			$('#depth').attr("value", "2");	
			$('#parent').attr("value", parent_text);			
			$('#h_dp_parent').attr("value", parent_id);
			
		});
		
		//3depth 관련
		$("#btn_2depth").click(function() {
			if($('#h_new_check').val()=="modi" && $('#h_prv_dp_depth').val() !="3") {
				$('#alert').html('같은 단계로만 이동이 가능합니다.');
				return;
			}
			var parent_id = $("#sele_2depth option:selected").val();
			var parent_text =$("#sele_2depth option:selected").text();
			$('#depth').attr("value", "3");	
			$('#parent').attr("value", parent_text);			
			$('#h_dp_parent').attr("value", parent_id);
		});
		
		
		function NewData(){
			$('#title_alert').html("신규부서 등록중");
			$('#h_new_check').attr("value", "new");
			$('#name').attr("value", "");
			$('#depth').attr("value","");
			$('#parent').attr("value","");
			$('#rank').attr("value", "1");
		}
		
	</script>
	<script>
	//신규저장 및 내용수정
	
	$("#save").click(function() {
		if($('#name').val()=="") {
			$('#alert').html('이름을 작성해주세요.');
			$('#name').focus();
			return;
		}
		if($('#depth').val()=="" || $('#parent').val()=="") {
			$('#alert').html('상위 부서를 선택해주세요.');
			return;
		}
		if($('#rank').val()=="") {
			$('#alert').html('출력 순서를 숫자로 적어주세요.');
			$('#rank').focus();
			return;
		}
		if(!confirm("저장 하시겠습니까?")) return;
		var dp_id = $('#h_dp_id').val();
		var dp_name = $('#name').val();
		var dp_depth = $('#depth').val();
		var dp_pid = $('#h_dp_parent').val();
		var dp_rank = $('#rank').val();
		if($('#h_new_check').val()=="new"){  //신규 저장
			$.ajax({
				type : "GET",
				url : "/departmentInsert.do",
				data : {
					"dp_name" : dp_name,
					"dp_depth" : dp_depth,
					"dp_pid" : dp_pid,
					"dp_rank" : dp_rank
				},
				dataType : "text",
				success : function(response) {
					alert("등록하였습니다.");
					window.location.reload() ;
				}
			});
		}
		if($('#h_new_check').val()=="modi"){ //업데이트
			$.ajax({
				type : "GET",
				url : "/departmentUpdate.do",
				data : {
					"dp_id" : dp_id,
					"dp_name" : dp_name,
					"dp_depth" : dp_depth,
					"dp_pid" : dp_pid,
					"dp_rank" : dp_rank
				},
				dataType : "text",
				success : function(response) {
					alert("업데이트 하였습니다.");
					window.location.reload(); 
				}
			});
		}
	});
	</script>
	<script>
	$("#delete").click(function() {
		if($('#name').val()=="") {
			$('#alert').html('이름을 작성해주세요.');
			$('#name').focus();
			return;
		}
		if($('#depth').val()=="" || $('#parent').val()=="") {
			$('#alert').html('상위부서를 선택해주세요.');
			return;
		}
		if($('#rank').val()=="") {
			$('#alert').html('출력순서를 숫자로 적어주세요.');
			$('#rank').focus();
			return;
		}
		if(!confirm("삭제 하시겠습니까?")) return;
		var dp_id = $('#h_dp_id').val();
		$.ajax({
			type : "GET",
			url : "/departmentDelete.do",
			contentType : "application/json; charset=utf-8",
			dataType : "text",
			data: {
				"dp_id" : dp_id
			},
			success : function(response) {
				if (response == "OK") {
					alert("삭제되었습니다.");
				} else {
					alert("삭제할 수 없습니다.")
				}
				window.location.reload(); 
			},
			error : function(response) {
			}
		});
	});
	</script>
	<script>
	$("#example01").click(function() {
		$.ajax({
			type : "POST",
			url : "/departmentInsert.do",
			contentType : "application/json; charset=utf-8",
			dataType : "text",
			success : function(response) {
				
				console.log($('#h_new_check').val());
				console.log($('#h_dp_depth').val());
				console.log($('#h_dp_id').val());
				console.log($('#name').val());
				console.log($('#depth').val());
				console.log($('#parent').val());
				console.log($('#rank').val());
				if (response == "OK") {
					alert("등록 되었습니다.");
				}
			},
			error : function(response) {
			}
		});
	});
		$("#btn_depth_select").click(function() {
			var depth = $('#depth').val();
			if (depth == "1")
				return;
			//alert(depth);
			$.ajax({
				type : "GET",
				url : "/departmentList_Select.do",
				data : {
					"depth" : depth
				},
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				success : function(response) {
					console.log("성공");
					console.log(response);
					var datas = new Array();
					var info = "";
					$.each(response, function(idx, item) {
						info += item.dp_id + " ";
					});
					alert(info);
				}
			});
		});
		
		
	</script>
</body>
</html>
