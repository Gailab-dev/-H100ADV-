<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 로그인, 회원가입 기능의 SQL 문이 작성된 -->
<mapper namespace="com.disabled.mapper.LoginMapper">
	
	<!-- id와 pw값을 비교하여 둘 다 같은 경우, 해당 map을 리턴 -->
	<select id="existUsrByIdAndPwd" resultType="map">
		SELECT u_id, u_pwd_changed, u_grade, u_login_fail_count 
		FROM tbl_user
		WHERE 1=1 
			AND u_login_id = #{id}
			AND u_login_pwd = #{pwd}
		LIMIT 1		
	</select>
	
	<!-- 최초 사용자 로그인시 비밀번호 변경 -->
	<update id="updateNewPwd">
		UPDATE tbl_user
		SET	
			u_login_pwd = #{encryptPwd}
			, u_pwd_changed = 1
		WHERE u_id = #{uId}	
	
	</update>
	
	<!-- 기존 비밀번호 가져오기 -->
		<select id="getPwd" resultType="string">
		SELECT u_login_pwd
		FROM tbl_user
		WHERE u_id = #{uId}	
	</select>
	
	<select id = "getMyInfo" resultType="map">
		SELECT *
		FROM tbl_user
		WHERE u_id = #{uId}
	</select>
	
	<select id = "getLoginId" resultType="string">
		SELECT u_login_id
		FROM tbl_user
		WHERE u_id = #{uId}
	</select>
	
	<select id = "getLoginIdByNameAndPhone" resultType="string">
		SELECT u_login_id
		FROM tbl_user
		WHERE u_name = #{u_name}
		AND u_phone = #{u_phone}
	</select>
	
	<select id="getCountUserIdAsParam" resultType="int">
		SELECT COUNT(1)
		FROM tbl_user
		WHERE u_login_id = #{uLoginId}
	
	</select>
	
	<insert id="insertUser">
		INSERT INTO tbl_user(
			u_org_id
			, u_login_id 
			, u_login_pwd
			, u_name
			, u_email
			, u_phone
			, u_grade
			, u_region
			, u_pwd_changed
			, u_req_user
			, u_mod_user
			, u_req_date
			, u_mod_date
			
		) VALUES(
			1
			, #{u_login_id}
			, #{encryptPwd}
			, #{u_name}
			, #{u_email}
			, #{u_phone}
			, 1
			, #{u_region}
			, 1
			, 1
			, 1
			, NOW()
			, NOW()
		)
	
	</insert>
	
	<!-- 아이디, 이름, 전번으로 비밀번호의 수 가져오기  -->
	<select id="getCountPwd" resultType="int">
		SELECT COUNT(1)
		FROM tbl_user
		WHERE 
			1=1
			AND u_login_id = #{u_login_id}
			AND u_name = #{u_name}
			AND u_phone = #{u_phone}
	
	</select>
	
	<!-- 이름, 아이디, 전화번호로 식별번호 가져오기 -->
	<select id="getLoginIdWithNameAndIdAndPhone" resultType="int">
		SELECT u_id
		FROM tbl_user
		WHERE
			1=1
			AND u_login_id = #{u_login_id}
			AND u_name = #{u_name}
			AND u_phone = #{u_phone}
	</select>
	

</mapper>