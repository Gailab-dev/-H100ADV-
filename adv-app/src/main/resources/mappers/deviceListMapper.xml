<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 장비 리스트 화면 SQL -->
<mapper namespace="com.disabled.mapper.DeviceListMapper">
	
	<!-- 디바이스 정보 -->
	<select id="getDeviceInfo" parameterType="map" resultType="map">
		SELECT dv_id, dv_name, dv_addr, dv_serial_number, dv_status
		FROM tbl_device
		WHERE 
			1=1
	        <if test="searchKeyword != null">
		        AND (
		            dv_name LIKE CONCAT(
		                '%',
		                REPLACE(#{searchKeyword}, '_', '\\_'),
		                '%'
		            ) ESCAPE '\\'
		            OR 
		            dv_addr LIKE CONCAT(
		                '%',
		                REPLACE(#{searchKeyword}, '_', '\\_'),
		                '%'
		            ) ESCAPE '\\'
		        )
	        </if>
		ORDER BY dv_addr DESC,dv_name DESC	
        LIMIT #{recordCountPerPage} 
        OFFSET #{firstIndex}	
	</select>
	
	<!-- 선택한 디바이스의 ip값에 따른 ip값  -->
	<select id="getDvIpByDvId" parameterType="int" resultType="String">
		SELECT dv_ip
		FROM tbl_device
		WHERE dv_id = #{dvId}	
	</select>
	
	<!-- 검색 조건에 따른 전체 record 수 -->
	<select id="getTotalRecordCount" resultType="int">
		SELECT COUNT(1)
		FROM tbl_device
		WHERE 
			1=1
	        <if test="searchKeyword != null">
		        AND (
		            dv_name LIKE CONCAT(
		                '%',
		                REPLACE(#{searchKeyword}, '_', '\\_'),
		                '%'
		            ) ESCAPE '\\'
		            OR 
		            dv_addr LIKE CONCAT(
		                '%',
		                REPLACE(#{searchKeyword}, '_', '\\_'),
		                '%'
		            ) ESCAPE '\\'
		        )
	        </if>
	</select>
	
	<!-- 디바이스 등록 -->
	<insert id="insertDeviceInfo">
		INSERT INTO tbl_device(
			dv_org_id
			, dv_name
			, dv_addr
			, dv_ip
			, dv_status
			, dv_reg_user
			, dv_mod_user
			, dv_reg_date
			, dv_mod_date
			, dv_serial_number
		)
		VALUES(
			1
			, #{dvName}
			, #{dvAddr}
			, #{dvIp}
			, #{dvStatus}
			, 1
			, 1
			, NOW()
			, NOW()
			, #{dvSerialNumber}
		)
	</insert>
	
	<!-- 디바이스 수정 -->
	<update id="updateDeviceInfo">
		UPDATE tbl_device
		SET
			dv_name = #{dvName}
			, dv_addr = #{dvAddr}
			, dv_ip = #{dvIp}
			, dv_status = #{dvStatus}
			, dv_mod_user = 1
			, dv_mod_date = NOW()
			, dv_serial_number = #{dvSerialNumber}			
		WHERE dv_id = #{dvId}	
	
	</update>
	
	<!-- 디바이스 1건 삭제 -->
	<delete id="deleteDeviceInfo">
		DELETE FROM tbl_device
		WHERE dv_id = #{dvId}
	</delete>
	
	<!-- 디바이스 1개 정보 -->
	<select id="getOneDeviceInfo" resultType="map">
		SELECT dv_name, dv_addr, dv_ip, dv_serial_number
		FROM tbl_device
		WHERE dv_id = #{dvId}
	</select>
	
		<!-- 디바이스명과 주소로 같은 디바이스 존재하는지 조회  -->
	<select id="getDeviceCountDvNameAndAddr" parameterType="map" resultType="int">
		SELECT COUNT(1)
		FROM tbl_device
		WHERE dv_name = #{dvName}
		AND dv_addr = #{dvAddr}
		<if test="dvId != null">
			AND dv_id != #{dvId}
		</if>
	</select>
	
	<!-- 모든 디바이스 ip 조회  -->
	<select id="getAllDvIp" resultType="String">
		SELECT DISTINCT dv_ip
		FROM tbl_device
	</select>
	
	<!-- 디바이스 IP별 상태값 수정 -->
	<update id="updateDeviceStatus">
		UPDATE tbl_device
		SET dv_status = #{dvStatus}
			, dv_mod_date = NOW()
		WHERE dv_ip = #{dvIp}	
	
	</update>

</mapper>